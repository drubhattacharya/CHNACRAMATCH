<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CHNA–CRA Navigation Dashboard — 3 Tiers</title>

  <!-- Dependencies (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Match LAI Navigation Dashboard look & feel (light, crisp, blue/green accents) */
    :root{
      --blue:#1f7fd6; --green:#18a76f; --ink:#0b1f33; --muted:#2f4556;
      --border:rgba(11,31,51,.16); --bg1:#e7f3ff; --bg2:#e7fbf2; --card:#ffffff;
      --warn:#d78b00; --bad:#d93b3b;
      --shadow:0 12px 28px rgba(11,31,51,.06);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 520px at 15% 10%, var(--bg1), rgba(255,255,255,0)),
        radial-gradient(1100px 520px at 85% 20%, var(--bg2), rgba(255,255,255,0)),
        linear-gradient(180deg, #ffffff, #f7fbff);
      color:var(--ink);
      font-size:16px;
      line-height:1.45;
    }
    header{
      padding:14px 18px 12px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.88);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
    }
    .wrap{max-width:1250px;margin:0 auto;padding:14px 18px 40px;}
    h1{margin:0;font-size:20px;}
    .sub{margin-top:4px;color:var(--muted);font-size:13px;}
    .grid{display:grid; gap:12px;}
    .grid-2{grid-template-columns: 380px 1fr;}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center;}
    button{
      border:1px solid var(--border); background:#fff; border-radius:12px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    button.primary{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
    button.secondary{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
    button.danger{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .tabbtn{
      border:1px solid var(--border); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
    .pill{
      display:inline-block; padding:2px 10px; border-radius:999px;
      background:rgba(31,127,214,.10); border:1px solid rgba(31,127,214,.22);
      font-size:12px; font-weight:800;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff;
      font-size:12px; font-weight:900; color:var(--ink);
    }
    .small{font-size:12px;color:var(--muted);}
    .mono{font-family:var(--mono);}

    .kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns:1fr;} }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:800;}
    .kpi .value{font-size:22px;font-weight:900;margin-top:2px;}
    .kpi .hint{font-size:12px;color:var(--muted); margin-top:4px; line-height:1.35;}

    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border:1px solid var(--border); padding:8px; vertical-align:top;}
    th{background:rgba(31,127,214,.08); text-align:left;}
    .callout{
      border:1px dashed rgba(11,31,51,.25);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.7);
    }
    .okbar{
      display:none; border:1px solid rgba(24,167,111,.35); background:rgba(24,167,111,.08);
      border-radius:14px; padding:10px 12px; margin-top:12px;
    }
    .errbar{
      display:none; border:1px solid rgba(217,59,59,.35); background:rgba(217,59,59,.08);
      border-radius:14px; padding:10px 12px; margin-top:12px;
    }

    .view{display:none;}
    .view.active{display:block;}

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .field{flex:1 1 320px; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff;}
    .field label{display:flex; justify-content:space-between; gap:10px; font-weight:900; font-size:13px;}
    input, select{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:12px;
      font-size:14px; color:var(--ink); background:#fff;
    }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fff;
    }
    .b-strong{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
    .b-mod{border-color:rgba(215,139,0,.35); background:rgba(215,139,0,.08);}
    .b-weak{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}

    .codebox{
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      color:var(--ink);
    }

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:980px){ .split{grid-template-columns:1fr;} }

    .gate{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--warn);
      border:1px solid rgba(0,0,0,.08);
    }
    .dot.good{background: var(--green);}
    .dot.bad{background: var(--bad);}
  </style>
</head>

<body>
<header>
  <div class="wrap" style="padding:0 18px;">
    <h1>CHNA–CRA Navigation Dashboard — 3-Tier Navigation</h1>
    <div class="sub">Tier 1: CHNA Materiality • Tier 2: CRA Eligibility & Application Readiness • Tier 3: Total Program Cost & ROI</div>

    <div class="tabs" aria-label="Navigation tabs">
      <button class="tabbtn active" id="tab_t1" data-view="t1">Tier 1 — Assessment</button>
      <button class="tabbtn" id="tab_t2" data-view="t2">Tier 2 — CRA Readiness</button>
      <button class="tabbtn" id="tab_t3" data-view="t3">Tier 3 — ROI & Break-even</button>
      <button class="tabbtn" id="tab_t4" data-view="t4">Tier 4 — Implementation</button>
      <button class="tabbtn" id="tab_t5" data-view="t5">Tier 5 — Outcomes</button>
      <button class="tabbtn" id="tab_t6" data-view="t6">Tier 6 — Evaluation</button>
      <button class="tabbtn" id="tab_drafts" data-view="drafts">Application Drafts</button>

      <div class="gate">
        <span class="chip"><span id="gateDot" class="dot"></span> <span id="gateText">Tier 3 locked until Tier 2 score ≥ 60</span></span>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="errbar" class="errbar"></div>
  <div id="okbar" class="okbar"></div>

  <!-- LEFT + RIGHT layout -->
  <div class="grid grid-2">
    <!-- LEFT: Upload and controls -->
    <div class="card">
      <div class="btnbar">
        <button class="primary" id="btn_process">Process Files</button>
        <button class="secondary" id="btn_demo">Load Demo (Transportation differential)</button>
        <button id="btn_export">Export report (JSON)</button>
        <button class="danger" id="btn_reset">Reset</button>
      </div>

      <div class="field" style="margin-top:8px;">
        <label><span>Upload documents</span><span class="pill">PDF/TXT</span></label>
        <input id="file_input" type="file" multiple accept=".pdf,.txt"/>
        <div class="small" style="margin-top:8px;">
          Upload: CHNA (PDF), Schedule H (PDF), CRA exam/procedures (PDF), internal memos (TXT).
          Processing occurs locally in your browser.
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="chip">Docs: <span class="mono" id="docs_count">0</span></div>
        <div class="chip">Evidence: <span class="mono" id="ev_count">0</span></div>
        <div class="chip">Top Tier 2 score: <span class="mono" id="top_t2">—</span></div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">Transportation spotlight (required)</div>
        <div class="small" style="margin-top:6px;">
          This dashboard explicitly elevates transportation when a subgroup (e.g., ages 65–74) shows materially higher barriers than overall population.
          This is the “amplification” logic that turns a seemingly small overall rate into a partnership-grade opportunity.
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="chip">Overall transportation: <b id="t_overall">—</b></div>
          <div class="chip">Age 65–74: <b id="t_6574">—</b></div>
          <div class="chip">Amplification: <b id="t_amp">—</b></div>
        </div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">How CRA eligibility is stated here</div>
        <div class="small" style="margin-top:6px;">
          Tier 2 includes the specific qualifying criterion satisfied (e.g., “community support services targeted to LMI individuals”)
          and cites the applicable topic and example (e.g., transportation to medical treatments).
        </div>
      </div>
    </div>

    <!-- RIGHT: Views -->
    <div class="card">
      <!-- Tier 1 -->
      <section id="view_t1" class="view active">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Top disparity</div>
            <div class="value" id="kpi_top">—</div>
            <div class="hint" id="kpi_top_hint">Process documents to compute materiality.</div>
          </div>
          <div class="kpi">
            <div class="label">Top subgroup concentration</div>
            <div class="value" id="kpi_conc">—</div>
            <div class="hint">Highlights where a targeted program will have the strongest case.</div>
          </div>
          <div class="kpi">
            <div class="label">Priority shortlist</div>
            <div class="value" id="kpi_shortlist">—</div>
            <div class="hint">Items recommended to advance to Tier 2.</div>
          </div>
          <div class="kpi">
            <div class="label">Partner angle</div>
            <div class="small" id="kpi_angle">—</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Disparities Materiality Matrix</div>
            <div class="small" style="margin-bottom:10px;">
              Materiality score (0–100) is computed from <b>magnitude</b>, <b>subgroup differential</b>, and <b>prominence across documents</b>.
              Transportation receives a boost when subgroup amplification is detected (e.g., 8.5% vs 2.7%).
            </div>

            <div class="split">
              <div style="overflow:auto;">
                <table id="tbl_materiality"></table>
              </div>
              <div>
                <div style="font-weight:900; margin-bottom:6px;">Top disparities chart</div>
                <canvas id="chart_materiality" height="230"></canvas>
                <div class="small" style="margin-top:8px;">Chart ranks the highest scoring disparities (0–100).</div>
              </div>
            </div>

            <div class="callout" style="margin-top:10px;">
              <div style="font-weight:900;">Tier 1 recommendation snapshot</div>
              <div class="small" id="tier1_recs" style="margin-top:6px;">—</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Evidence snippets (traceability)</div>
            <div class="small" style="margin-bottom:10px;">Each signal preserves the triggering text plus document and page.</div>
            <div style="overflow:auto;">
              <table id="tbl_evidence"></table>
            </div>
          </div>
        </div>
      
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">CHNA Quality & Compliance Gap Analysis (Tier 1 enhancement)</div>
          <div class="small" style="margin-bottom:10px;">
            This section scores uploaded CHNA / Implementation Strategy (IS) documents against commonly missing IRS documentation elements and the “written comments” community input requirement.
            It is designed to address well-documented national gaps: missing documentation elements and low public-facing evidence of community input. 
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">CHNA documentation completeness</div>
              <div class="value" id="kpi_chna_q">—</div>
              <div class="hint" id="kpi_chna_q_hint">Based on 7 IRS CHNA documentation elements (0–100).</div>
            </div>
            <div class="kpi">
              <div class="label">Implementation Strategy completeness</div>
              <div class="value" id="kpi_is_q">—</div>
              <div class="hint">Based on 3 IRS IS elements (0–100).</div>
            </div>
            <div class="kpi">
              <div class="label">Written comments requirement</div>
              <div class="value" id="kpi_input_req">—</div>
              <div class="hint">Checks for: solicitation, ≥1 comment received, and how comments were used.</div>
            </div>
            <div class="kpi">
              <div class="label">Public availability signal</div>
              <div class="value" id="kpi_public_avail">—</div>
              <div class="hint">Heuristic: presence of “available on website”/“posted”/“public comment” language in uploaded files.</div>
            </div>
          </div>

          <div class="split" style="margin-top:12px;">
            <div style="overflow:auto;">
              <table id="tbl_chna_gaps"></table>
            </div>
            <div>
              <div class="callout">
                <div style="font-weight:900;">Actionable remediation plan (auto-generated)</div>
                <div class="small" id="chna_gap_recs" style="margin-top:6px;">Process documents to generate.</div>
              </div>
              <div class="callout" style="margin-top:10px;">
                <div style="font-weight:900;">Evidence (traceability)</div>
                <div class="small" style="margin-top:6px;">The table records the triggering snippet and page to speed CHNA/IS remediation edits.</div>
              </div>
            </div>
          </div>
        </div>
</section>

      <!-- Tier 2 -->
      <section id="view_t2" class="view">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Best opportunity score</div>
            <div class="value" id="t2_best">—</div>
            <div class="hint" id="t2_best_hint">Tier 2 score ≥ 60 unlocks Tier 3.</div>
          </div>
          <div class="kpi">
            <div class="label">Transportation opportunity</div>
            <div class="value" id="t2_transport">—</div>
            <div class="hint">Always evaluated as a candidate due to common CHNA access barriers.</div>
          </div>
          <div class="kpi">
            <div class="label">Eligibility criterion</div>
            <div class="small" id="t2_crit">—</div>
          </div>
          <div class="kpi">
            <div class="label">Application packet</div>
            <div class="small" id="t2_packet">—</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;">
              <div>
                <div style="font-weight:900;">CRA Eligibility & Application Readiness</div>
                <div class="small">Includes explicit criterion satisfied for CRA and what evidence is required for exam defensibility.</div>
              </div>
              <button class="secondary" id="btn_use_top">Use top opportunity in Tier 3</button>
            </div>

            <div style="overflow:auto; margin-top:10px;">
              <table id="tbl_cra"></table>
            </div>

            <div class="callout" style="margin-top:10px;">
              <div style="font-weight:900;">Exam-ready prompts (joint memo)</div>
              <div class="small" id="exam_prompts" style="margin-top:6px;">—</div>
            </div>
          </div>
        </div>
      </section>

      
      
      <!-- Tier 3 -->
      <section id="view_t3" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 3 — NEMT No‑Show ROI (Excel‑Parity) + Coding ROI Layer</div>
          <div class="small" style="margin-top:6px;">
            The base ROI remains <b>Excel‑parity</b> (no added fixed/startup costs). Optionally activate a <b>Coding ROI Layer</b> to model
            incremental upside from SDOH ICD‑10 Z‑code documentation and CPT reporting capture associated with improved visit completion and workflow reliability.
          </div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="callout">
            <div style="font-weight:900;">Base ROI definition (Excel‑parity)</div>
            <div class="small" style="margin-top:6px;">
              <b>Transport no‑shows</b> = Visits × No‑show rate × Transport share<br/>
              <b>Prevented no‑shows</b> = Transport no‑shows × Mitigation rate<br/>
              <b>Net benefit</b> = (Prevented × Net revenue) − (Prevented × Marginal clinical cost) − (Prevented × Trip cost × (1 + Overhead rate))
            </div>
          </div>

          <div style="font-weight:900; margin:12px 0 6px;">A) Volume & Access</div>
          <div class="row">
            <div class="field"><label>Annual targeted outpatient visits</label><input id="a_visits" type="number" value="40000"/></div>
            <div class="field"><label>No‑show rate (0.20 or 20)</label><input id="a_noshow" type="number" value="0.20" step="0.01"/></div>
            <div class="field"><label>Share due to transportation (0.30 or 30)</label><input id="a_share" type="number" value="0.30" step="0.01"/></div>
            <div class="field"><label>Net revenue per visit ($)</label><input id="a_netrev" type="number" value="225"/></div>
            <div class="field"><label>Marginal clinical cost per visit ($)</label><input id="a_margc" type="number" value="90"/></div>
          </div>

          <div style="font-weight:900; margin:10px 0;">B) Program Inputs</div>
          <div class="row">
            <div class="field"><label>Mitigation rate (0.50 or 50)</label><input id="b_mitig" type="number" value="0.50" step="0.01"/></div>
            <div class="field"><label>Trip cost ($)</label><input id="b_trip" type="number" value="60"/></div>
            <div class="field"><label>Overhead rate (0.10 or 10)</label><input id="b_over" type="number" value="0.10" step="0.01"/></div>
          </div>

          <div style="font-weight:900; margin:10px 0;">C) CRA Scope (optional for CRA outputs)</div>
          <div class="row">
            <div class="field"><label>LMI share (0.90 or 90)</label><input id="c_lmi" type="number" value="0.90" step="0.01"/></div>
            <div class="field"><label>AA share (1.00 or 100)</label><input id="c_aa" type="number" value="1.00" step="0.01"/></div>
            <div class="field"><label>Bank annual contribution ($/yr)</label><input id="c_bank" type="number" value="50000"/></div>
          </div>

          <div class="hr"></div>

          <div class="callout">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <div>
                <div style="font-weight:900;">Coding ROI Layer (optional)</div>
                <div class="small" style="margin-top:6px;">
                  This layer models incremental financial upside from improved coding/documentation capture enabled by visit completion and SDOH workflow reliability.
                  It does <b>not</b> alter the base Excel-parity ROI; it adds an optional “coding uplift” line item.
                </div>
              </div>
              <div class="chip">
                <span style="font-weight:900;">Activate</span>
                <input id="toggle_coding" type="checkbox" style="margin-left:10px; transform:scale(1.2);" />
              </div>
            </div>

            <div id="coding_box" style="display:none; margin-top:10px;">
              <div class="row">
                <div class="field">
                  <label>Z‑code documentation capture rate (0–100%)</label>
                  <input id="z_rate" type="number" value="25" min="0" max="100" step="1"/>
                  <div class="small" style="margin-top:6px;">Percent of prevented visits where SDOH Z-codes are documented (e.g., Z59.*, Z60.*, Z63.*, Z75.*).</div>
                </div>
                <div class="field">
                  <label>Estimated $ uplift per Z‑coded encounter</label>
                  <input id="z_uplift" type="number" value="20" min="0" step="1"/>
                  <div class="small" style="margin-top:6px;">Conservative placeholder (e.g., improved reimbursement capture, care coordination value, risk documentation).</div>
                </div>
                <div class="field">
                  <label>CPT capture uplift rate (0–100%)</label>
                  <input id="cpt_rate" type="number" value="15" min="0" max="100" step="1"/>
                  <div class="small" style="margin-top:6px;">Percent of prevented visits where additional coding/quality capture occurs (e.g., Category II reporting, documentation completeness).</div>
                </div>
                <div class="field">
                  <label>Estimated $ uplift per CPT‑captured encounter</label>
                  <input id="cpt_uplift" type="number" value="15" min="0" step="1"/>
                  <div class="small" style="margin-top:6px;">Conservative placeholder (e.g., downcoding protection, quality program attribution, operational billing confidence).</div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Apply coding uplift to</label>
                  <select id="coding_base">
                    <option value="prevented" selected>Prevented no‑shows (recovered visits)</option>
                    <option value="all">All targeted visits (broad workflow uplift)</option>
                  </select>
                  <div class="small" style="margin-top:6px;">Default is conservative: apply only to recovered visits.</div>
                </div>
                <div class="field">
                  <label>Notes (optional)</label>
                  <input id="coding_notes" type="text" placeholder="e.g., Z75.3 transportation barrier documented via screening; CPT II captured for quality reporting."/>
                </div>
              </div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" onclick="render_roi()">Run ROI</button>
          </div>

          <div class="kpis" style="margin-top:10px;">
            <div class="kpi"><div class="label">Total program cost (transport + overhead)</div><div class="value" id="o_cost">—</div><div class="hint">Used for ROI denominator and lender-facing artifacts.</div></div>
            <div class="kpi"><div class="label">Net Annual Benefit (base, Excel‑parity)</div><div class="value" id="o_net">—</div><div class="hint">Recovered margin minus program cost (no added fixed/startup costs).</div></div>
            <div class="kpi"><div class="label">Coding uplift (optional)</div><div class="value" id="o_code">—</div><div class="hint">Optional incremental upside from documentation/coding capture.</div></div>
            <div class="kpi"><div class="label">Net benefit incl. coding uplift</div><div class="value" id="o_total_net">—</div><div class="hint">Base net + coding uplift.</div></div>
            <div class="kpi"><div class="label">ROI incl. coding uplift (x)</div><div class="value" id="o_roi">—</div><div class="hint">Net ÷ program cost.</div></div>
            <div class="kpi"><div class="label">Break-even trip cost max</div><div class="value" id="o_tripmax">—</div><div class="hint">Net revenue per recovered visit minus marginal clinical cost.</div></div>
          </div></div>

          <div class="split" style="margin-top:12px;">
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">ROI decomposition</div>
              <canvas id="roi_bar" height="260"></canvas>
              <div class="small" style="margin-top:8px;">Base ROI bars are Excel parity; coding uplift is displayed separately.</div>
            </div>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">CRA impact outputs</div>
              <div id="cra_box" class="codebox" style="min-height:260px;">Run ROI to populate outputs.</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none; margin-top:12px;">
            <div style="font-weight:900; margin-bottom:6px;">Audit‑ready output</div>
            <div id="roi_audit" class="codebox">Run ROI to generate memo output.</div>
          </div>
        </div>
      </section>



      
      <!-- Tier 4 -->
      <section id="view_t4" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 4 — Implementation Plan (prototype)</div>
          <div class="small" style="margin-top:6px;">
            This tier turns the selected Tier 2 opportunity into an executable plan: roles, timeline, workflow, data capture, and audit artifacts.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">30‑60‑90 Day Implementation Plan</div>
          <div class="small" style="margin-bottom:10px;">Auto-populated from Tier 2 selection and Tier 3 ROI assumptions when available.</div>
          <div id="impl_plan" class="codebox" style="min-height:260px;">Run Tier 3 and select an opportunity to generate an implementation plan.</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="secondary" onclick="generate_impl_plan()">Generate plan</button>
            <button onclick="copy_block('impl_plan')">Copy</button>
          </div>
        </div>
      </section>

      <!-- Tier 5 -->
      <section id="view_t5" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 5 — Outcomes Reporting (prototype)</div>
          <div class="small" style="margin-top:6px;">
            This tier defines the reporting package for hospitals and banks: operational outputs, beneficiary counts, CRA metrics, and financial performance updates.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">Quarterly Outcomes Report Template</div>
          <div class="small" style="margin-bottom:10px;">Includes CRA outputs (LMI trips, AA trips, bank $/LMI trip) and hospital operational KPIs.</div>
          <div id="outcomes_report" class="codebox" style="min-height:260px;">Run Tier 3 to populate a draft outcomes report template.</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="secondary" onclick="generate_outcomes_report()">Generate report</button>
            <button onclick="copy_block('outcomes_report')">Copy</button>
          </div>
        </div>
      </section>

      <!-- Tier 6 -->
      <section id="view_t6" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 6 — Evaluation Plan (prototype)</div>
          <div class="small" style="margin-top:6px;">
            This tier formalizes evaluation: baseline, comparison approach, data sources, metrics, and governance for continuous improvement and CRA defensibility.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">Evaluation Plan Template</div>
          <div class="small" style="margin-bottom:10px;">Designed for audit and re-use across projects (NEMT and broader SDOH interventions).</div>
          <div id="eval_plan" class="codebox" style="min-height:260px;">Generate an evaluation plan using Tier 1 evidence + Tier 2 criteria + Tier 3 assumptions.</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="secondary" onclick="generate_eval_plan()">Generate plan</button>
            <button onclick="copy_block('eval_plan')">Copy</button>
          </div>
        </div>
      </section>

<!-- Drafts -->
      <section id="view_drafts" class="view">
        <div class="callout">
          <div style="font-weight:900;">CRA Application Draft Generator</div>
          <div class="small" style="margin-top:6px;">
            Use the dropdowns to generate exam‑defensible draft artifacts from the dashboard analysis (Tier 1–3). 
            Drafts pull from uploaded evidence (disparity measures + citations), Tier 2 eligibility criterion and scope guidance,
            and the most recent Tier 3 cost/ROI scenario (when run).
          </div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="row">
            <div class="field">
              <label>Artifact type</label>
              <select id="draft_type">
                <option value="cra_memo">CRA Activity Justification Memo</option>
                <option value="exam_narrative">Examiner‑Facing Narrative (PE language)</option>
                <option value="crosswalk">CRA Eligibility Crosswalk Table</option>
                <option value="term_sheet">Joint Partnership Term Sheet (working draft)</option>
                <option value="chna_brief">CHNA Implementation Alignment Brief</option>
                <option value="monitor_plan">Monitoring & Evidence Plan</option>
                <option value="pnl">Borrower P&L Statement (Hospital)</option>
                <option value="proforma_3yr">Project Pro Forma Budget (3-Year)</option>
                <option value="lender_pnl_3yr">Lender-Facing P&L (3-Year, line-item)</option>
                <option value="lender_proforma_3yr">Lender-Facing Pro Forma (3-Year, line-item)</option>
              </select>
              <div class="small" style="margin-top:6px;">Choose the document you want to generate. Everything is editable after download.</div>
            </div>

            <div class="field">
              <label>Opportunity / Activity</label>
              <select id="draft_activity">
                <option value="auto">Auto (Top Tier 2)</option>
                <option value="nmt">Transportation‑to‑care (NEMT)</option>
                <option value="food">Food access support</option>
                <option value="care">Care navigation / referral infrastructure</option>
              </select>
              <div class="small" style="margin-top:6px;">Default uses the highest‑scoring Tier 2 opportunity.</div>
            </div>

            <div class="field">
              <label>Voice & tone</label>
              <select id="draft_tone">
                <option value="bank">Bank CRA file (formal)</option>
                <option value="joint" selected>Joint bank–hospital memo (board‑ready)</option>
                <option value="hospital">Hospital internal approval (ops/finance)</option>
              </select>
              <div class="small" style="margin-top:6px;">Changes emphasis, not the underlying facts.</div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" id="btn_generate_draft">Generate Draft</button>
            <button id="btn_copy_draft">Copy</button>
            <button class="secondary" id="btn_download_draft">Download .txt</button>
          </div>

          <div class="split" style="margin-top:10px;">
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Preview</div>
              <div id="draft_preview" class="codebox" style="min-height:340px;">Select an artifact type and click <b>Generate Draft</b>.</div>
            </div>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Quick controls</div>
              <div class="small" style="margin-bottom:10px;">
                These fields are optional. They allow quick tailoring without editing after export.
              </div>
              <div class="row">
                <div class="field">
                  <label>Project name (optional)</label>
                  <input id="draft_project_name" type="text" placeholder="e.g., Senior Access Shuttle — 12‑month pilot"/>
                </div>
                <div class="field">
                  <label>Implementing partner (optional)</label>
                  <input id="draft_partner" type="text" placeholder="e.g., County Transit / Nonprofit / Ride broker"/>
                </div>
              </div>
              <div class="row">
                <div class="field">
                  <label>Pro forma growth (%/yr)</label>
                  <input id="draft_growth" type="number" value="5" min="0" step="0.5"/>
                </div>
                <div class="field">
                  <label>Cost inflation (%/yr)</label>
                  <input id="draft_infl" type="number" value="3" min="0" step="0.5"/>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Assessment area notes (optional)</label>
                  <input id="draft_scope_note" type="text" placeholder="e.g., Target ZIPs 56xxx within AA; document beneficiary location."/>
                </div>
                <div class="field">
                  <label>Funding structure (optional)</label>
                  <input id="draft_structure" type="text" placeholder="e.g., CRA‑credited grant to nonprofit; service agreement with hospital."/>
                </div>
              </div>

              <div class="callout" style="margin-top:10px;">
                <div style="font-weight:900;">Tip</div>
                <div class="small" style="margin-top:6px;">
                  Run Tier 3 (<b>Cost & ROI</b>) first to populate the draft with a program cost baseline and break‑even assumptions.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
  // ------------------------------
  // PDF.js setup
  // ------------------------------
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // ------------------------------
  // Utilities
  // ------------------------------
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function fmtPct(x){ return (x==null || isNaN(x)) ? "—" : `${x.toFixed(1)}%`; }
  function fmtInt(x){ return (x==null || isNaN(x)) ? "—" : `${Math.round(x).toLocaleString()}`; }
  function fmtMoney(x){
    if(x==null || isNaN(x)) return "—";
    const sign = x < 0 ? "-" : "";
    const v = Math.abs(x);
    return `${sign}$${v.toLocaleString(undefined,{maximumFractionDigits:0})}`;
  }
  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function showErr(msg){ const e=document.getElementById("errbar"); e.style.display="block"; e.innerHTML = msg; }
  function clearErr(){ const e=document.getElementById("errbar"); e.style.display="none"; e.innerHTML = ""; }
  function showOk(msg){ const o=document.getElementById("okbar"); o.style.display="block"; o.innerHTML = msg; }

  // ------------------------------
  // State
  // ------------------------------
  const state = {
    docs: [], // {name,type,pages,textByPage[]}
    evidence: [], // {disparity, snippet, doc, page}
    findings: [], // Tier1: {id,key,disparity,segment,magnitude,prominence,concentration,score,recommend,evidenceRef}
    opportunities: [], // Tier2: {opp,kind,tests,criterion,strength,score,scope,checklist}
    selectedOpp: null,
    transport: {overall:null, age6574:null},
    chnaEval: [], // per-doc CHNA/IS documentation + community input requirement checks
    model: null // Tier 3 scenario cache for draft generator
  };

  // Disparities list (includes transportation explicitly)
  const DISPARITIES = [
    {key:"transport", label:"Transportation barrier", keywords:["transportation","transit"], metric:"% reporting transportation problems"},
    {key:"access", label:"Access to care barrier", keywords:["could not get an appointment","delayed care"], metric:"% delaying needed care"},
    {key:"food", label:"Food insecurity", keywords:["food insecurity","food shelf"], metric:"% reporting food insecurity"},
    {key:"housing", label:"Housing need", keywords:["housing needs","housing"], metric:"% reporting housing needs"},
    {key:"financial", label:"Financial need", keywords:["financial needs","cost too much"], metric:"% reporting financial needs"}
  ];

  // CRA criteria mapping (explicit criterion satisfied)
  // Note: This is written in a regulator-friendly way, citing the OCC illustrative list structure (Topic L — community support services).
  const CRA_CRITERIA = {
    nmt: {
      criterion: "Community development services / community support services targeted to low- or moderate-income (LMI) individuals — transportation to medical treatments.",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — example: transportation to medical treatments for LMI individuals."
    },
    food: {
      criterion: "Community development services / community support services targeted to LMI individuals — food access support as a community service (when structured for LMI populations).",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — community services for LMI individuals (structure matters)."
    },
    care: {
      criterion: "Community development services targeted to LMI individuals — health services / community services that improve access (depending on structure and beneficiaries).",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — health/community services for LMI individuals (structure matters)."
    }
  };

  // ------------------------------
  // Extraction
  // ------------------------------
  async function extractPdfText(file){
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    const numPages = pdf.numPages;
    const textByPage = [];
    for(let p=1; p<=numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str).filter(Boolean);
      const text = strings.join(" ").replace(/\s+/g,' ').trim();
      textByPage.push(text);
    }
    return {pages: numPages, textByPage};
  }
  async function extractTxt(file){
    const text = await file.text();
    return {pages: 1, textByPage: [text.replace(/\s+/g,' ').trim()]};
  }

  function recordEvidence(disparityLabel, snippet, doc, page){
    state.evidence.push({disparity:disparityLabel, snippet, doc, page});
  }

  function findPercentNear(text, keyword){
    const re = new RegExp(`${keyword}[\\s\\S]{0,160}?(\\d{1,2}(?:\\.\\d+)?)%`, "i");
    const m = text.match(re);
    if(!m) return null;
    const val = parseFloat(m[1]);
    if(isNaN(val)) return null;
    return {val, snippet: m[0].slice(0,280)};
  }
  function findAge6574Transport(text){
    const re = /65\s*[-–]\s*74[\s\S]{0,160}transportation[\s\S]{0,80}?(\d{1,2}(?:\.\d+)?)%/i;
    const m = text.match(re);
    if(!m) return null;
    const val = parseFloat(m[1]);
    if(isNaN(val)) return null;
    return {val, snippet: m[0].slice(0,280)};
  }

  function addFinding(key, disparity, segment, magnitude, prominence, evidenceRef){
    const id = `${key}__${segment}`;
    const ex = state.findings.find(x=>x.id===id);
    if(ex){
      if(magnitude > ex.magnitude){
        ex.magnitude = magnitude;
        ex.prominence = Math.max(ex.prominence, prominence);
        ex.evidenceRef = evidenceRef;
      }
      return;
    }
    state.findings.push({
      id, key, disparity, segment, magnitude,
      prominence,
      concentration:0,
      score:0,
      recommend:"",
      evidenceRef
    });
  }

  function scanDoc(doc){
    const prominence = {};
    for(const d of DISPARITIES){ prominence[d.key]=0; }

    for(let i=0;i<doc.textByPage.length;i++){
      const t = doc.textByPage[i] || "";
      const lower = t.toLowerCase();

      // prominence by keywords
      for(const d of DISPARITIES){
        for(const kw of d.keywords){
          if(lower.includes(kw.toLowerCase())){ prominence[d.key] += 1; break; }
        }
      }

      // Transportation overall
      const tr = findPercentNear(t, "transportation");
      if(tr){
        recordEvidence("Transportation barrier", tr.snippet, doc.name, i+1);
        addFinding("transport", "Transportation barrier", "Overall", tr.val, prominence["transport"], `${doc.name} p.${i+1}`);
        if(state.transport.overall==null) state.transport.overall = tr.val;
      }
      // Transportation 65-74
      const tr6574 = findAge6574Transport(t);
      if(tr6574){
        recordEvidence("Transportation barrier", tr6574.snippet, doc.name, i+1);
        addFinding("transport", "Transportation barrier", "Age 65–74", tr6574.val, prominence["transport"], `${doc.name} p.${i+1}`);
        state.transport.age6574 = tr6574.val;
      }

      // Other disparities
      for(const d of DISPARITIES){
        if(d.key==="transport") continue;
        const primary = d.keywords[0];
        const p = findPercentNear(t, primary.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        if(p){
          recordEvidence(d.label, p.snippet, doc.name, i+1);
          addFinding(d.key, d.label, "Overall", p.val, prominence[d.key], `${doc.name} p.${i+1}`);
        }
      }
    }
  }


  // ------------------------------
  // Tier 1 enhancement: CHNA/IS documentation + community input requirement gap checks
  // Based on common IRS documentation elements assessed in the literature and the 3-part written comments requirement.
  // - CHNA documentation elements (7): community definition; methods; input from community; underserved populations described; prioritized needs; resources available; evaluation of impact.
  // - Implementation strategy elements (3): actions for each need; resources and anticipated impact; planned collaborations.
  // - Written comments requirement (3): solicitation method; ≥1 written comment received; explanation of how comments were taken into account.
  // These checks are heuristic (keyword-based) and intended to speed a gap analysis / remediation workflow.
  const CHNA_ELEMENTS = [
    {id:"community_def", label:"Definition of community served + how determined", pats:["definition of the community","community served","service area","community definition","how the community was determined"]},
    {id:"methods", label:"Process and methods used to conduct CHNA", pats:["methods","methodology","data sources","process used","approach","survey methodology","focus group"]},
    {id:"input", label:"How input was solicited and taken into account (broad interests)", pats:["input from persons who represent","broad interests of the community","community input","stakeholder input","community representatives"]},
    {id:"underserved", label:"Description of medically underserved / low-income / minority populations represented by input", pats:["medically underserved","low-income","minority populations","priority populations","vulnerable populations","underserved populations"]},
    {id:"priorities", label:"Prioritized description of significant health needs", pats:["prioritized","priority health needs","significant health needs","ranked","top needs","prioritization"]},
    {id:"resources", label:"Resources potentially available to address identified needs", pats:["resources available","available resources","community resources","assets","existing programs","capacity"]},
    {id:"impact_eval", label:"Evaluation of impact since the immediately preceding CHNA", pats:["evaluation of impact","impact of actions","progress since","results since last","prior CHNA","evaluation since"]},
  ];

  const IS_ELEMENTS = [
    {id:"is_actions", label:"Actions to address each health need", pats:["actions the hospital will take","strategy","interventions","action plan","will address"]},
    {id:"is_resources_impact", label:"Resources devoted + anticipated impact", pats:["resources devoted","anticipated impact","budget","investment","expected impact","metrics"]},
    {id:"is_collab", label:"Planned collaborations with other institutions", pats:["collaboration","partner","coalition","in partnership with","collaborate with","community partners"]},
  ];

  const WRITTEN_COMMENT_ELEMENTS = [
    {id:"wc_solicit", label:"How written comments were solicited (most recent CHNA/IS)", pats:["written comments","public comment","comment period","solicit","feedback form","survey","web-based","paper survey","community forum","open house","telephone"]},
    {id:"wc_received", label:"At least 1 written comment received", pats:["we received","comments were received","comment(s) received","written comment","responses received","feedback received"]},
    {id:"wc_used", label:"How comments were taken into account in current CHNA/IS", pats:["taken into account","incorporated","informed","used to update","we considered","resulting changes","we adjusted","we revised"]},
  ];

  function _findSnippet(text, pat){
    const idx = text.toLowerCase().indexOf(pat.toLowerCase());
    if(idx < 0) return null;
    const start = Math.max(0, idx-90);
    const end = Math.min(text.length, idx+170);
    return text.slice(start,end).replace(/\s+/g,' ').trim();
  }

  function evalDocForElements(doc){
    const all = (doc.textByPage||[]).join(" \n");
    const lower = all.toLowerCase();

    const isCHNA = lower.includes("community health needs assessment") || lower.includes("chna");
    const isIS = lower.includes("implementation strategy") || lower.includes("implementation plan") || lower.includes("implementation strategies");

    // Public availability signal (heuristic)
    const publicPats = ["available on our website","posted on our website","publicly available","public comment","comment period","available online"];
    const publicHit = publicPats.find(p=>lower.includes(p.toLowerCase()));
    const publicSnippet = publicHit ? _findSnippet(all, publicHit) : null;

    function scoreBlock(block){
      let hits = [];
      for(const el of block){
        let found = null;
        for(const p of el.pats){
          if(lower.includes(p.toLowerCase())){ found = p; break; }
        }
        const snippet = found ? _findSnippet(all, found) : null;
        hits.push({id:el.id, label:el.label, present: !!found, trigger: found || "", snippet: snippet || ""});
      }
      const presentCount = hits.filter(h=>h.present).length;
      const score = Math.round((presentCount / hits.length) * 100);
      return {score, hits, presentCount, total:hits.length};
    }

    const chna = scoreBlock(CHNA_ELEMENTS);
    const isb = scoreBlock(IS_ELEMENTS);
    const wc = scoreBlock(WRITTEN_COMMENT_ELEMENTS);

    const wcScore = wc.presentCount===3 ? 100 : (wc.presentCount===2 ? 67 : (wc.presentCount===1 ? 33 : 0));
    const publicScore = publicHit ? 100 : 0;

    return {
      doc: doc.name,
      isCHNA, isIS,
      chnaScore: chna.score,
      isScore: isb.score,
      writtenCommentsScore: wcScore,
      publicScore,
      chnaHits: chna.hits,
      isHits: isb.hits,
      wcHits: wc.hits,
      publicSnippet: publicSnippet || ""
    };
  }

  function renderChnaGaps(){
    const tbl = document.getElementById("tbl_chna_gaps");
    if(!tbl) return;

    if(!state.chnaEval || state.chnaEval.length===0){
      tbl.innerHTML = "<tr><th>Document</th><th>CHNA score</th><th>IS score</th><th>Written comments</th><th>Public availability</th><th>Top gaps (auto)</th><th>Evidence</th></tr><tr><td colspan='7'>Process documents to populate.</td></tr>";
      const rec = document.getElementById("chna_gap_recs");
      if(rec) rec.textContent = "Process documents to generate.";
      document.getElementById("kpi_chna_q").textContent = "—";
      document.getElementById("kpi_is_q").textContent = "—";
      document.getElementById("kpi_input_req").textContent = "—";
      document.getElementById("kpi_public_avail").textContent = "—";
      return;
    }

    // Aggregate KPIs across docs (take max score across docs, since some uploads may be partial excerpts)
    const chnaMax = Math.max(...state.chnaEval.map(x=>x.chnaScore||0));
    const isMax = Math.max(...state.chnaEval.map(x=>x.isScore||0));
    const wcMax = Math.max(...state.chnaEval.map(x=>x.writtenCommentsScore||0));
    const pubMax = Math.max(...state.chnaEval.map(x=>x.publicScore||0));

    document.getElementById("kpi_chna_q").textContent = chnaMax + "/100";
    document.getElementById("kpi_is_q").textContent = isMax + "/100";
    document.getElementById("kpi_input_req").textContent = wcMax===100 ? "Meets (3/3)" : (wcMax===67 ? "Partial (2/3)" : (wcMax===33 ? "Weak (1/3)" : "Missing (0/3)"));
    document.getElementById("kpi_public_avail").textContent = pubMax===100 ? "Detected" : "Not detected";

    let html = "<tr><th>Document</th><th>CHNA score</th><th>IS score</th><th>Written comments</th><th>Public availability</th><th>Top gaps (auto)</th><th>Evidence</th></tr>";
    const gapsAll = [];
    for(const d of state.chnaEval){
      const gaps = [];
      // pick top 3 gaps across blocks
      const miss = []
        .concat(d.chnaHits.filter(h=>!h.present).map(h=>({label:h.label, snippet:h.snippet})))
        .concat(d.isHits.filter(h=>!h.present).map(h=>({label:h.label, snippet:h.snippet})))
        .concat(d.wcHits.filter(h=>!h.present).map(h=>({label:h.label, snippet:h.snippet})));

      miss.slice(0,3).forEach(m=>gaps.push(m.label));
      gapsAll.push(...gaps);

      const ev = (d.publicSnippet ? `Public signal: ${d.publicSnippet}` : "") || (d.wcHits.find(h=>h.present && h.snippet)?.snippet || "") || (d.chnaHits.find(h=>h.present && h.snippet)?.snippet || "");
      html += `<tr>
        <td class="mono"><b>${escapeHtml(d.doc)}</b></td>
        <td class="mono">${d.isCHNA ? (d.chnaScore + "/100") : "—"}</td>
        <td class="mono">${d.isIS ? (d.isScore + "/100") : "—"}</td>
        <td>${d.writtenCommentsScore===100 ? '<span class="badge b-strong">Meets (3/3)</span>' : (d.writtenCommentsScore>=67 ? '<span class="badge b-mod">Partial</span>' : '<span class="badge b-weak">Gap</span>')}</td>
        <td>${d.publicScore===100 ? '<span class="badge b-strong">Detected</span>' : '<span class="badge b-weak">Not detected</span>'}</td>
        <td>${escapeHtml(gaps.join("; ") || "—")}</td>
        <td>${escapeHtml(ev || "—")}</td>
      </tr>`;
    }
    tbl.innerHTML = html;

    // Remediation recs
    const rec = [];
    const needsWritten = wcMax < 100;
    if(needsWritten){
      rec.push("Written comments compliance (3-part) is incomplete: add a documented solicitation method (paper + web + in-person options), confirm ≥1 written comment received, and explicitly state how comments changed priorities or strategies.");
    }
    if(chnaMax < 85){
      rec.push("CHNA documentation gaps detected: ensure the CHNA explicitly includes (a) community definition and how it was determined, (b) methods/data sources, (c) who provided input and which underserved populations they represent, (d) prioritized needs, (e) resources available, and (f) evaluation of impact since the prior CHNA.");
    }
    if(isMax < 85){
      rec.push("Implementation Strategy gaps detected: ensure the IS lists actions for each prioritized need, associated resources and anticipated impact, and planned collaborations/partners.");
    }
    if(pubMax < 100){
      rec.push("Public availability signal not detected in the uploaded excerpts: ensure the CHNA and IS are clearly posted online and the document states where/how the public can access them.");
    }
    rec.push("Operationalizing fix: add a one-page ‘CHNA/IS Compliance Addendum’ template with these elements, then paste into the CHNA and IS PDFs for audit-ready completeness.");

    const recEl = document.getElementById("chna_gap_recs");
    if(recEl) recEl.textContent = rec.join(" ");
  }

  function computeMateriality(){
    // Compute concentration per key (subgroup - overall)
    const byKey = {};
    for(const f of state.findings){
      if(!byKey[f.key]) byKey[f.key]=[];
      byKey[f.key].push(f);
    }
    for(const key of Object.keys(byKey)){
      const list = byKey[key];
      const overall = list.find(x=>x.segment==="Overall");
      for(const f of list){
        f.concentration = (f.segment!=="Overall" && overall) ? Math.max(0, f.magnitude - overall.magnitude) : 0;
      }
    }

    // Materiality score:
    // magnitude (0-60), concentration (0-25), prominence (0-15)
    // transportation amplification: if 65–74 exists and overall exists, add bonus up to +10
    let transportBonus = 0;
    if(state.transport.overall!=null && state.transport.age6574!=null && state.transport.overall>0){
      const amp = state.transport.age6574 / state.transport.overall;
      transportBonus = clamp((amp-1)*8, 0, 10); // up to 10 points bonus
    }

    for(const f of state.findings){
      const magScore = clamp((f.magnitude/30)*60, 0, 60);
      const concScore = clamp((f.concentration/15)*25, 0, 25);
      const promScore = clamp((f.prominence/6)*15, 0, 15);
      let score = Math.round(magScore + concScore + promScore);
      if(f.key==="transport") score = clamp(score + Math.round(transportBonus), 0, 100);
      f.score = score;
      f.recommend = (score>=70) ? "Advance (high)" : (score>=55 ? "Advance (moderate)" : "Defer/monitor");
    }
    state.findings.sort((a,b)=>b.score-a.score);
  }

  function buildOpportunities(){
    const bestByKey = {};
    for(const f of state.findings){
      if(!bestByKey[f.key]) bestByKey[f.key]=f;
    }

    // Always include transportation opportunity (requirement), score based on findings if present
    const opps = [];

    function scoreOpportunity(eligibilityClarity, responsiveness, attributionStrength, docBurden){
      return Math.round(0.30*eligibilityClarity + 0.30*responsiveness + 0.25*attributionStrength + 0.15*(100-docBurden));
    }

    // Attribution heuristic
    const attribution = 70; // default; can be enhanced later if we parse AA geos
    const scope = "Prefer AA attribution: document beneficiary location (ZIP/tract/county) and service delivery within AA; if broader, document proportional benefit.";

    // Transportation (NEMT) — explicit criterion
    {
      const f = bestByKey.transport || {score:55}; // keep it evaluable even if CHNA extraction fails
      const eligibility = 90; // strong
      const responsiveness = clamp(f.score, 0, 100);
      const burden = 35;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Transportation-to-care (NEMT) — missed appointment mitigation",
        kind:"nmt",
        tests:"Service • Investment (as structured) • CD Loans (as structured)",
        criterion: CRA_CRITERIA.nmt.criterion + " " + CRA_CRITERIA.nmt.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA excerpt(s) with overall + age-band differential; target population definition (LMI and/or qualifying segments); service area map; vendor/partner agreement; invoices; ride logs; beneficiary counts; monitoring report cadence."
      });
    }

    // Food
    if(bestByKey.food){
      const f = bestByKey.food;
      const eligibility = 80;
      const responsiveness = clamp(f.score,0,100);
      const burden = 45;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Food access support — distribution / vouchers / meal supports",
        kind:"food",
        tests:"Investment • Service (depending on structure)",
        criterion: CRA_CRITERIA.food.criterion + " " + CRA_CRITERIA.food.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA food measure; LMI targeting method; partner agreement; distribution logs; invoices; beneficiary counts; monitoring plan."
      });
    }

    // Access
    if(bestByKey.access){
      const f = bestByKey.access;
      const eligibility = 75;
      const responsiveness = clamp(f.score,0,100);
      const burden = 50;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Care navigation / referral infrastructure — access enablement",
        kind:"care",
        tests:"Service • Investment (as structured)",
        criterion: CRA_CRITERIA.care.criterion + " " + CRA_CRITERIA.care.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA access barrier evidence; workflow description; staffing records; referral counts; LMI targeting; monitoring plan."
      });
    }

    opps.sort((a,b)=>b.score-a.score);
    state.opportunities = opps;
    state.selectedOpp = opps.length ? opps[0] : null;
  }

  function tier3Unlocked(){
    return state.opportunities.some(o=>o.score>=60);
  }

  // ------------------------------
  // Rendering
  // ------------------------------
  let chartMateriality=null, chartROI=null, chartTrend=null;

  function strengthBadge(str){
    if(str==="Strong") return `<span class="badge b-strong">Strong</span>`;
    if(str==="Moderate") return `<span class="badge b-mod">Moderate</span>`;
    return `<span class="badge b-weak">Weak</span>`;
  }

  function renderTransportSpotlight(){
    const o = state.transport.overall;
    const a = state.transport.age6574;
    document.getElementById("t_overall").textContent = (o==null) ? "—" : fmtPct(o);
    document.getElementById("t_6574").textContent = (a==null) ? "—" : fmtPct(a);
    if(o!=null && a!=null && o>0){
      const amp = a/o;
      document.getElementById("t_amp").textContent = `${amp.toFixed(1)}×`;
    }else{
      document.getElementById("t_amp").textContent = "—";
    }
  }

  function renderTier1(){
    // KPIs
    if(state.findings.length){
      const top = state.findings[0];
      document.getElementById("kpi_top").textContent = `${top.disparity} (${top.score})`;
      document.getElementById("kpi_top_hint").textContent = `Magnitude ${fmtPct(top.magnitude)} • Prominence ${top.prominence} • Δ ${top.concentration.toFixed(1)}.`;
      const subs = state.findings.filter(x=>x.segment!=="Overall").sort((a,b)=>b.concentration-a.concentration);
      if(subs.length){
        const s = subs[0];
        document.getElementById("kpi_conc").textContent = `${s.disparity} Δ${s.concentration.toFixed(1)}% (${s.segment})`;
      }else{
        document.getElementById("kpi_conc").textContent = "—";
      }
      const shortlist = state.findings.filter(f=>f.score>=55).length;
      document.getElementById("kpi_shortlist").textContent = `${shortlist}`;
      const angle = (state.transport.overall!=null && state.transport.age6574!=null) ?
        "Transportation appears small overall, but materially higher in older adults — strong case for targeted NEMT." :
        "Use highest materiality disparities to form a joint bank–hospital decision memo.";
      document.getElementById("kpi_angle").textContent = angle;
    }

    // Materiality table
    const tbl = document.getElementById("tbl_materiality");
    if(!state.findings.length){
      tbl.innerHTML = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr><tr><td colspan='8'>No results yet.</td></tr>";
    }else{
      let html = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr>";
      for(const f of state.findings.slice(0,10)){
        html += `<tr>
          <td><b>${escapeHtml(f.disparity)}</b></td>
          <td>${escapeHtml(f.segment)}</td>
          <td class="mono">${fmtPct(f.magnitude)}</td>
          <td class="mono">${f.concentration.toFixed(1)}%</td>
          <td class="mono">${f.prominence}</td>
          <td class="mono"><b>${f.score}</b></td>
          <td>${escapeHtml(f.recommend)}</td>
          <td class="mono">${escapeHtml(f.evidenceRef||"—")}</td>
        </tr>`;
      }
      tbl.innerHTML = html;
    }

    // Materiality chart
    const top = state.findings.slice(0,8);
    const labels = top.map(f=>`${f.disparity}${f.segment!=="Overall" ? " ("+f.segment+")" : ""}`);
    const vals = top.map(f=>f.score);
    if(chartMateriality) chartMateriality.destroy();
    chartMateriality = new Chart(document.getElementById("chart_materiality"), {
      type:"bar",
      data:{labels, datasets:[{label:"Materiality (0–100)", data:vals}]},
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
          y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}, beginAtZero:true, max:100}
        }
      }
    });

    // Tier 1 recs
    const rec = [];
    if(state.transport.overall!=null && state.transport.age6574!=null){
      rec.push(`Transportation: overall ${fmtPct(state.transport.overall)} vs age 65–74 ${fmtPct(state.transport.age6574)} (amplification ${(state.transport.age6574/state.transport.overall).toFixed(1)}×). Treat as a high-value access lever (missed appointments).`);
    }
    const adv = state.findings.filter(f=>f.score>=70).slice(0,3);
    if(adv.length){
      rec.push(`Advance now: ${adv.map(x=>x.disparity).join(", ")}.`);
    }else{
      rec.push("Advance now: highest scoring disparity and validate geography + target segment in Tier 2.");
    }
    rec.push("Create a joint bank–hospital memo: (1) documented need, (2) target segment/geography, (3) CRA criterion satisfied, (4) documentation plan, (5) cost baseline and KPI monitoring.");
    document.getElementById("tier1_recs").textContent = rec.join(" ");

    // Tier 1 enhancement: CHNA/IS gap analysis
    if(typeof renderChnaGaps === "function") renderChnaGaps();
  }

  function renderEvidence(){
    const tbl = document.getElementById("tbl_evidence");
    if(!state.evidence.length){
      tbl.innerHTML = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr><tr><td colspan='4'>No evidence captured yet.</td></tr>";
      return;
    }
    const slice = state.evidence.slice(-25).reverse();
    let html = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr>";
    for(const e of slice){
      html += `<tr>
        <td>${escapeHtml(e.disparity)}</td>
        <td>${escapeHtml(e.snippet)}</td>
        <td class="mono">${escapeHtml(e.doc)}</td>
        <td class="mono">${e.page}</td>
      </tr>`;
    }
    tbl.innerHTML = html;
  }

  function renderTier2(){
    const tbl = document.getElementById("tbl_cra");
    if(!state.opportunities.length){
      tbl.innerHTML = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr><tr><td colspan='7'>No opportunities yet.</td></tr>";
      return;
    }
    let html = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr>";
    for(const o of state.opportunities){
      html += `<tr>
        <td><b>${escapeHtml(o.opp)}</b></td>
        <td>${escapeHtml(o.tests)}</td>
        <td>${escapeHtml(o.criterion)}</td>
        <td>${strengthBadge(o.strength)}</td>
        <td class="mono"><b>${o.score}</b></td>
        <td>${escapeHtml(o.scope)}</td>
        <td>${escapeHtml(o.checklist)}</td>
      </tr>`;
    }
    tbl.innerHTML = html;

    const top = state.opportunities[0];
    document.getElementById("t2_best").textContent = `${top.score}`;
    document.getElementById("t2_best_hint").textContent = top.opp;

    const tOpp = state.opportunities.find(x=>x.kind==="nmt");
    document.getElementById("t2_transport").textContent = tOpp ? `${tOpp.score} (${tOpp.strength})` : "—";
    document.getElementById("t2_crit").textContent = tOpp ? tOpp.criterion : "—";
    document.getElementById("t2_packet").textContent = tOpp ? "CHNA evidence + LMI targeting + AA attribution + invoices + service logs + beneficiary counts + monitoring" : "—";

    document.getElementById("top_t2").textContent = `${top.score}`;

    // Gate
    const unlocked = tier3Unlocked();
    const dot = document.getElementById("gateDot");
    dot.classList.remove("good","bad");
    if(unlocked){ dot.classList.add("good"); document.getElementById("gateText").textContent = "Tier 3 unlocked (Tier 2 score ≥ 60)"; }
    else { dot.classList.add("bad"); document.getElementById("gateText").textContent = "Tier 3 locked until Tier 2 score ≥ 60"; }

    // Prompts
    document.getElementById("exam_prompts").textContent =
      "1) Document the disparity + affected segment (CHNA excerpt with page). 2) State the CRA qualifying criterion satisfied (and why benefit is targeted to LMI/qualifying population). 3) Define assessment area attribution (who benefited, where). 4) Provide invoices/contracts and beneficiary counts. 5) Define baseline metric + monitoring cadence.";
  }

  function setTier3FromOpportunity(opp){
    if(!opp) return;
    // Tier 3 currently models the NEMT scenario. If transportation is selected, prefill a conservative transport-share proxy.
    // (Keeps the existing Tier 3 ROI model intact.)
    if(opp.kind==="nmt" && state.transport.overall!=null){
      // Map CHNA-reported transportation barrier (% with transport problems) into a conservative "share due to transportation" proxy.
      const proxyPct = clamp(state.transport.overall*3.0, 5, 70); // heuristic: 2.7% -> ~8.1% (bounded)
      const el = document.getElementById("a_share");
      if(el) el.value = (proxyPct/100).toFixed(2); // accept decimal or percent; _normRate handles both
    }
  }

  function runTier3(){
    
    const activity = document.getElementById("inp_activity").value;
    const months = parseInt(document.getElementById("inp_months").value||"12",10);

    const annual = parseFloat(document.getElementById("inp_annual").value||"0");
    const baseRate = parseFloat(document.getElementById("inp_base").value||"0")/100;
    const share = parseFloat(document.getElementById("inp_share").value||"0")/100;
    const red = parseFloat(document.getElementById("inp_red").value||"0")/100;

    const covPct = parseFloat(document.getElementById("inp_cov").value||"25");
    const weightMode = document.getElementById("inp_weight_mode").value; // weighted | flat
    const senSharePct = clamp(parseFloat(document.getElementById("inp_sen_share").value||"25"), 0, 100);

    const benefitPer = parseFloat(document.getElementById("inp_benefit").value||"0");
    const startup = parseFloat(document.getElementById("inp_startup").value||"0");
    const fixed = parseFloat(document.getElementById("inp_fixed").value||"0");
    const varCost = parseFloat(document.getElementById("inp_var").value||"0");
    const unitsPer = parseFloat(document.getElementById("inp_units").value||"1");

    // Coverage and weighting logic:
    // Eligible touchpoints that receive support (targeted coverage).
    const eligibleTouchpoints = annual * (covPct/100);

    // Transport amplification factor from CHNA (65–74 vs overall) when available.
    let ampFactor = 1.0;
    if(state.transport.overall != null && state.transport.age6574 != null && state.transport.overall > 0){
      ampFactor = state.transport.age6574 / state.transport.overall; // e.g., 8.5/2.7 = 3.15x
    }
    if(weightMode === "flat") ampFactor = 1.0;

    // Effective barrier share adjusts upward when seniors are prioritized (higher transport barrier).
    const senShare = senSharePct/100;
    const effBarrierShare = clamp(share * ((1-senShare)*1.0 + (senShare*ampFactor)), 0, 1);

    // Disruptions among those offered support
    const baselineDisrupt = eligibleTouchpoints * baseRate;
    const barrierDisrupt = baselineDisrupt * effBarrierShare;
    const prevented = barrierDisrupt * red;

    // Units and benefit (annualized)
    const unitsAnnual = prevented * unitsPer;
    const grossAnnual = prevented * benefitPer;

    // cost over horizon: startup + fixed*months + variable*(annualUnits*months/12)*varCost
    const totalCostH = startup + fixed*months + (unitsAnnual*(months/12)*varCost);
    const annualCost = totalCostH*(12/months);
    const netAnnual = grossAnnual - annualCost;

    // Persist last model outputs for draft generator
    state.model = {
      activity, months, annual_touchpoints: annual,
      baseline_rate_pct: (baseRate*100),
      barrier_share_pct: (share*100),
      reduction_pct: (red*100),
      coverage_pct: Math.round(covPct),
      weight_mode: weightMode,
      seniors_share_pct: Math.round(senSharePct),
      amp_factor: (state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall) : null,
      prevented_disruptions: prevented,
      units_annual: unitsAnnual,
      startup, fixed_monthly: fixed, variable_unit_cost: varCost, units_per_prevented: unitsPer,
      total_cost_horizon: totalCostH,
      annual_cost: annualCost,
      gross_annual_benefit: grossAnnual,
      net_annual: netAnnual
    };


    document.getElementById("kpi_cost").textContent = fmtMoney(annualCost);
    document.getElementById("kpi_gross").textContent = fmtMoney(grossAnnual);
    document.getElementById("kpi_net").textContent = fmtMoney(netAnnual);
    const covReadout = document.getElementById("cov_readout");
    if(covReadout) covReadout.textContent = `${Math.round(covPct)}%`;

    // Charts: ROI
    if(chartROI) chartROI.destroy();
    chartROI = new Chart(document.getElementById("chart_roi"),{
      type:"bar",
      data:{labels:["Annual benefit","Annual cost","Annual net"], datasets:[{label:"$", data:[grossAnnual, annualCost, netAnnual]}]},
      options:{plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
                y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}, beginAtZero:true}}}
    });

    // Monthly trend
    const labels = Array.from({length:months}, (_,i)=>`M${i+1}`);
    const monthlyBenefit = grossAnnual/12;
    const monthlyUnits = unitsAnnual/12;
    const monthlyCost = (startup/months) + fixed + (monthlyUnits*varCost);
    const monthlyNet = monthlyBenefit - monthlyCost;

    const netSeries = labels.map(()=>monthlyNet);
    let cum=0; const cumSeries = netSeries.map(v=>(cum+=v));
    if(chartTrend) chartTrend.destroy();
    chartTrend = new Chart(document.getElementById("chart_trend"),{
      type:"line",
      data:{labels, datasets:[
        {label:"Monthly net", data:netSeries, tension:.25},
        {label:"Cumulative net", data:cumSeries, tension:.25}
      ]},
      options:{plugins:{legend:{labels:{color:"#2f4556"}}},
        scales:{x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
                y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}}}}
    });

    // Break-even chart: vary coverage from 5..60
    const covs = [];
    const nets = [];
    const zeroLine = [];
    const minC = 5, maxC = 60;
    for(let c=minC; c<=maxC; c+=1){
      const eligible = annual * (c/100);
      const baseDis = eligible * baseRate;
      const barDis = baseDis * effBarrierShare;
      const prev = barDis * red;
      const unitsA = prev * unitsPer;
      const grossA = prev * benefitPer;
      const totalCost = startup + fixed*months + (unitsA*(months/12)*varCost);
      const annCost = totalCost*(12/months);
      covs.push(c);
      nets.push(grossA - annCost);
      zeroLine.push(0);
    }

    const ctxBE = document.getElementById("chart_breakeven");
    if(ctxBE){
      if(window.__beChart) window.__beChart.destroy();
      window.__beChart = new Chart(ctxBE, {
        type:"line",
        data:{
          labels: covs.map(x=>`${x}%`),
          datasets:[
            {label:"Annual net impact", data: nets, tension:.25},
            {label:"Break-even ($0)", data: zeroLine, borderDash:[6,6], tension:0}
          ]
        },
        options:{
          plugins:{legend:{labels:{color:"#2f4556"}}},
          scales:{
            x:{ticks:{color:"#2f4556", maxRotation:0, autoSkip:true}, grid:{color:"rgba(11,31,51,.08)"}},
            y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}}
          }
        }
      });
    }

    // Audit memo
    const topOpp = state.selectedOpp || state.opportunities[0] || null;
    const crit = topOpp ? topOpp.criterion : CRA_CRITERIA[activity]?.criterion || "—";
    const memo =
`TIER 3 — TOTAL PROGRAM COST & ROI (Audit-ready)

Selected activity: ${activity}
CRA criterion satisfied: ${crit}

A) Documented transportation disparity (CHNA)
- Transportation overall: ${state.transport.overall==null? "Not detected" : fmtPct(state.transport.overall)}
- Transportation age 65–74: ${state.transport.age6574==null? "Not detected" : fmtPct(state.transport.age6574)}
- Amplification factor: ${(state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall).toFixed(1)+"×" : "—"}

B) Targeting design (this is the partnership lever)
- Targeted coverage of eligible patients: ${Math.round(covPct)}%
- Allocation mode: ${weightMode === "weighted" ? "Senior-weighted (prioritize 65–74)" : "Flat allocation"}
- Seniors share of eligible touchpoints: ${Math.round(senSharePct)}%
- Effective barrier share (after weighting): ${(effBarrierShare*100).toFixed(1)}%

C) Cost baseline (answers: “How much does it cost?”)
- Startup (one-time): ${fmtMoney(startup)}
- Fixed monthly cost: ${fmtMoney(fixed)}
- Variable unit cost: ${fmtMoney(varCost)}
- Units per prevented disruption: ${unitsPer.toFixed(2)}
- Estimated annual units: ${fmtInt(unitsAnnual)}
- Annualized program cost: ${fmtMoney(annualCost)}

D) Impact (annualized)
- Prevented disruptions: ${fmtInt(prevented)}
- Annual gross benefit: ${fmtMoney(grossAnnual)}
- Annual net impact: ${fmtMoney(netAnnual)}

E) Evidence packet
- CHNA excerpt(s) + subgroup differential + page refs
- Target population definition (LMI method) + geography attribution
- Contracts/invoices + service logs + beneficiary counts
- Monitoring cadence with baseline vs observed + corrective actions

Generated: ${new Date().toISOString()}`;
    document.getElementById("audit_out").textContent = memo;

  }

  // ------------------------------
  // Export
  // ------------------------------
  function exportReport(){
    const report = {
      generated_at: new Date().toISOString(),
      docs: state.docs.map(d=>({name:d.name, pages:d.pages, type:d.type})),
      transport: state.transport,
      tier1_findings: state.findings,
      tier2_opportunities: state.opportunities,
      evidence: state.evidence.slice(-100)
    };
    const blob = new Blob([JSON.stringify(report,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "chna_cra_dashboard_report.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ------------------------------
  // Tabs
  // ------------------------------
  function setView(view){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById("view_"+view).classList.add("active");
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.getElementById("tab_"+view).classList.add("active");
  }
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setView(btn.dataset.view));
  });

  // ------------------------------
  // Buttons
  // ------------------------------
  document.getElementById("btn_export").addEventListener("click", exportReport);

  document.getElementById("btn_reset").addEventListener("click", ()=>{
    clearErr();
    state.docs=[]; state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null; state.chnaEval=[];
    state.transport={overall:null, age6574:null};
    document.getElementById("docs_count").textContent="0";
    document.getElementById("ev_count").textContent="0";
    document.getElementById("top_t2").textContent="—";
    document.getElementById("tbl_materiality").innerHTML="";
    document.getElementById("tbl_evidence").innerHTML="";
    document.getElementById("tbl_cra").innerHTML="";
    if(document.getElementById("tbl_chna_gaps")) document.getElementById("tbl_chna_gaps").innerHTML="";
    if(document.getElementById("chna_gap_recs")) document.getElementById("chna_gap_recs").textContent="—";
    document.getElementById("audit_out").textContent="";
    if(chartMateriality) chartMateriality.destroy();
    if(chartROI) chartROI.destroy();
    if(chartTrend) chartTrend.destroy();
    renderTransportSpotlight();
    showOk("Reset complete.");
  });

  document.getElementById("btn_demo").addEventListener("click", ()=>{
    clearErr();
    // Demo based on your exact framing: 2.7% overall, 8.5% age 65-74
    const demoText =
      "Why did you not get or delay getting the preventative care you thought you needed? Total: I had transportation problems 2.7%. " +
      "Age 65-74: I had transportation problems 8.5%. " +
      "Of patients surveyed, 7.5% reported food insecurity and 6% reported housing needs. " +
      "Unweighted count 61. Martin County ZIP 56031.";
    state.docs=[{name:"Demo_CHNA.pdf", type:"pdf", pages:1, textByPage:[demoText]}];
    state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null; state.chnaEval=[];
    state.transport={overall:null, age6574:null};

    scanDoc(state.docs[0]);
    state.chnaEval = state.docs.map(evalDocForElements);
    computeMateriality();
    buildOpportunities();
    state.selectedOpp = state.opportunities[0] || null;

    document.getElementById("docs_count").textContent = state.docs.length;
    document.getElementById("ev_count").textContent = state.evidence.length;

    renderTransportSpotlight();
    renderTier1();
    renderEvidence();
    renderTier2();
    showOk("Demo loaded (transportation differential).");
  });

  document.getElementById("btn_process").addEventListener("click", async ()=>{
    clearErr();
    const files = Array.from(document.getElementById("file_input").files || []);
    if(!files.length){
      showErr("No files selected.");
      return;
    }
    state.docs=[]; state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null; state.chnaEval=[];
    state.transport={overall:null, age6574:null};

    for(const f of files){
      const ext = (f.name.split(".").pop()||"").toLowerCase();
      let parsed=null;
      try{
        if(ext==="pdf") parsed = await extractPdfText(f);
        else if(ext==="txt") parsed = await extractTxt(f);
        else continue;
        state.docs.push({name:f.name, type:ext, pages:parsed.pages, textByPage:parsed.textByPage});
      }catch(e){
        showErr(`Error parsing ${escapeHtml(f.name)}. Consider uploading a text version if scanned.`);
      }
    }

    // Scan
    for(const d of state.docs){ scanDoc(d); }
    state.chnaEval = state.docs.map(evalDocForElements);
    computeMateriality();
    buildOpportunities();
    state.selectedOpp = state.opportunities[0] || null;

    document.getElementById("docs_count").textContent = state.docs.length;
    document.getElementById("ev_count").textContent = state.evidence.length;

    renderTransportSpotlight();
    renderTier1();
    renderEvidence();
    renderTier2();
    showOk(`Processed ${state.docs.length} document(s).`);
  });

  document.getElementById("btn_use_top").addEventListener("click", ()=>{
    if(!state.opportunities.length){
      showErr("No Tier 2 opportunities available yet.");
      return;
    }
    state.selectedOpp = state.opportunities[0];
    setTier3FromOpportunity(state.selectedOpp);
    setView("t3");
    showOk("Tier 3 prefilled using top Tier 2 opportunity.");
  });

  const _btn_autofill = document.getElementById("btn_autofill");
  if(_btn_autofill){
    _btn_autofill.addEventListener("click", ()=>{
      if(!state.selectedOpp) state.selectedOpp = state.opportunities[0] || null;
      if(state.selectedOpp) setTier3FromOpportunity(state.selectedOpp);
      showOk("Tier 3 auto-fill applied from Tier 2.");
    });
  }
    showOk("Tier 3 auto-fill applied from Tier 2.");
  });

  const _btn_run = document.getElementById("btn_run");
  if(_btn_run){ _btn_run.addEventListener("click", runTier3); }
  // Live UI: keep coverage readout updated
  const covEl = document.getElementById("inp_cov");
  const covRead = document.getElementById("cov_readout");
  if(covEl && covRead){
    covRead.textContent = `${covEl.value}%`;
    covEl.addEventListener("input", ()=>{ covRead.textContent = `${covEl.value}%`; });
  }


  // Initial render placeholders
  renderTransportSpotlight();
  document.getElementById("tbl_materiality").innerHTML = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr><tr><td colspan='8'>Upload documents and click Process Files.</td></tr>";
  document.getElementById("tbl_evidence").innerHTML = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr><tr><td colspan='4'>—</td></tr>";
  document.getElementById("tbl_cra").innerHTML = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr><tr><td colspan='7'>—</td></tr>";
  if(document.getElementById("tbl_chna_gaps")) document.getElementById("tbl_chna_gaps").innerHTML = "<tr><th>Document</th><th>CHNA score</th><th>IS score</th><th>Written comments</th><th>Public availability</th><th>Top gaps (auto)</th><th>Evidence</th></tr><tr><td colspan=\"7\">—</td></tr>";
  if(document.getElementById("chna_gap_recs")) document.getElementById("chna_gap_recs").textContent = "Upload CHNA/IS documents and click Process Files.";

  // initialize draft UI
  wireDraftUI();


  // ------------------------------
  // Draft Generator (Application artifacts)
  // ------------------------------
  function pickOpportunity(kind){
    if(!state.opportunities || state.opportunities.length===0) return null;
    if(kind==="auto") return state.opportunities[0];
    return state.opportunities.find(o=>o.kind===kind) || state.opportunities[0];
  }

  function topEvidenceLines(maxLines=4){
    const lines = [];
    // Prefer transportation: show overall + 65–74 if available
    if(state.transport.overall!=null){
      lines.push(`- Transportation barrier overall: ${fmtPct(state.transport.overall)} (source: ${findEvidenceRef("Transportation barrier", "Overall") || "see evidence table"})`);
    }
    if(state.transport.age6574!=null){
      lines.push(`- Transportation barrier age 65–74: ${fmtPct(state.transport.age6574)} (source: ${findEvidenceRef("Transportation barrier", "Age 65") || "see evidence table"})`);
    }
    const others = state.findings.filter(f=>f.key!=="transport").slice(0, maxLines);
    for(const f of others){
      lines.push(`- ${f.disparity} (${f.segment}): ${fmtPct(f.magnitude)} (evidence: ${f.evidenceRef||"—"})`);
    }
    return lines.join("\n");
  }

  function findEvidenceRef(disparityLabel, segmentHint){
    const f = state.findings.find(x => x.disparity === disparityLabel && (!segmentHint || x.segment.includes(segmentHint)));
    return f ? f.evidenceRef : null;
  }

  function appPacketChecklist(kind){
    const common = [
      "CHNA excerpt(s) with page references (documented need + affected segment)",
      "Target population definition (LMI method and/or qualifying segment definition)",
      "Geographic attribution method (AA mapping via ZIP/tract/county; proportional benefit if broader)",
      "Contracts/MOUs/service agreements and invoices (clean audit trail)",
      "Service logs and beneficiary counts (units delivered; counts served; LMI estimate)",
      "Monitoring cadence (baseline vs observed; variance notes; corrective actions)"
    ];
    const nmt = [
      "Ride logs (date/time pickup/dropoff; appointment type; beneficiary ZIP)",
      "Broker/vendor KPIs (on-time rate, completed rides, cancellations, no-shows)",
      "Eligibility gating rationale (senior prioritization supported by CHNA differential)"
    ];
    const food = [
      "Distribution logs (units delivered; eligibility; geography)",
      "Partner controls (stock, delivery cadence, audit spot-checks)"
    ];
    const care = [
      "Workflow documentation (referral pathways; intake criteria)",
      "Referral counts and closed-loop outcomes"
    ];
    let extra = [];
    if(kind==="nmt") extra = nmt;
    if(kind==="food") extra = food;
    if(kind==="care") extra = care;
    return common.concat(extra).map(x=>`- ${x}`).join("\n");
  }

  function renderCrosswalkTable(opportunity){
    const rows = state.opportunities.map(o => {
      return `| ${o.opp} | ${o.tests} | ${o.criterion} | ${o.score} (${o.strength}) | ${o.scope} |`;
    });
    return [
      "| Opportunity | CRA test mapping | Criterion satisfied | Readiness | Scope guidance |",
      "|---|---|---|---|---|",
      ...rows
    ].join("\n");
  }

  function draftHeader(tone, projectName){
    const title = projectName ? projectName : "CRA‑Aligned Health Access Initiative";
    const toneLine = tone==="bank" ? "Bank CRA File Draft" : (tone==="hospital" ? "Hospital Internal Approval Draft" : "Joint Bank–Hospital Draft");
    return `${title}\n${toneLine}\nGenerated: ${new Date().toISOString()}\n`;
  }

  function generateDraft(draftType, oppKind, tone){
    const opp = pickOpportunity(oppKind);
    const projectName = (document.getElementById("draft_project_name")?.value || "").trim();
    const partner = (document.getElementById("draft_partner")?.value || "").trim();
    const scopeNote = (document.getElementById("draft_scope_note")?.value || "").trim();
    const structure = (document.getElementById("draft_structure")?.value || "").trim();

    const header = draftHeader(tone, projectName);
    const oppLine = opp ? `${opp.opp}\nCRA criterion satisfied: ${opp.criterion}\nCRA test mapping: ${opp.tests}\nReadiness: ${opp.score} (${opp.strength})\n` :
      "No Tier 2 opportunities available yet. Process documents first.\n";

    const evidence = topEvidenceLines(4);

    // Tier 3 model inclusion when available
    let modelBlock = "Tier 3 (cost & ROI): Not yet run. Run Tier 3 to populate cost baseline and break‑even assumptions.\n";
    if(state.model){
      modelBlock =
`Tier 3 (cost & ROI) — most recent scenario:
- Activity: ${state.model.activity}
- Coverage: ${state.model.coverage_pct}% (${state.model.weight_mode === "weighted" ? "senior‑weighted" : "flat"}; seniors share ${state.model.seniors_share_pct}%)
- Annualized program cost: ${fmtMoney(state.model.annual_cost)}
- Annual gross benefit: ${fmtMoney(state.model.gross_annual_benefit)}
- Annual net impact: ${fmtMoney(state.model.net_annual)}
- Assumptions: baseline disruption ${state.model.baseline_rate_pct.toFixed(1)}%, barrier share ${state.model.barrier_share_pct.toFixed(1)}%, reduction ${state.model.reduction_pct.toFixed(1)}%.\n`;
    }

    const orgLines = [
      partner ? `Implementing partner: ${partner}` : null,
      structure ? `Funding structure: ${structure}` : null,
      scopeNote ? `AA/scope note: ${scopeNote}` : null
    ].filter(Boolean).join("\n");

    if(draftType==="cra_memo"){
      return `${header}
1) Selected opportunity
${oppLine}
${orgLines ? orgLines + "\n" : ""}

2) Performance context and documented need (CHNA evidence)
${evidence}

3) Why this is responsive (what changes)
- The activity is targeted to the population segment(s) with the largest documented access disruption (e.g., seniors where transportation barrier is amplified).
- The implementation design includes traceable eligibility, service logs, and geography attribution to support exam defensibility.

4) Eligibility criterion satisfied (explicit)
${opp ? opp.criterion : "—"}

5) Scope and attribution
- Primary: attribute benefit within the bank’s assessment area by documenting beneficiary location (ZIP/tract/county) and delivery footprint.
- Secondary: if broader, document proportional benefit allocation and retain mapping evidence.

6) Program cost baseline and impact (decision support)
${modelBlock}

7) Evidence & monitoring packet (minimum)
${appPacketChecklist(opp ? opp.kind : "nmt")}
`;
    }

    if(draftType==="exam_narrative"){
      const amp = (state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall) : null;
      const ampLine = amp ? `Transportation barriers were amplified among older adults (~${amp.toFixed(1)}× vs overall), supporting a targeted access response.` : `Transportation barriers were documented in the CHNA and used to target the activity.`;
      return `${header}
Examiner‑facing narrative (Performance Evaluation style)

The institution supported a community services initiative aligned to documented local needs. ${ampLine}
The activity was structured to meet the CRA qualifying criterion as a community development service targeted to low‑ or moderate‑income individuals (criterion and support documentation retained). The institution maintained an audit trail including service logs, invoices, and beneficiary counts, and tracked outcomes against a defined baseline.

Evidence basis (CHNA excerpts):
${evidence}

CRA criterion satisfied:
${opp ? opp.criterion : "—"}

${state.model ? "Quantified program cost and impact (annualized):\n- Cost: "+fmtMoney(state.model.annual_cost)+"\n- Net impact: "+fmtMoney(state.model.net_annual)+"\n" : ""}`;
    }

    if(draftType==="crosswalk"){
      return `${header}
CRA Eligibility Crosswalk (working)

${renderCrosswalkTable(opp)}
`;
    }

    if(draftType==="term_sheet"){
      return `${header}
Joint Partnership Term Sheet (working draft)

Project: ${projectName || (opp ? opp.opp : "—")}
Purpose: Address documented access disparities through a targeted intervention aligned with CRA community development criteria.

Parties:
- Hospital: _______________________
- Bank: ___________________________
${partner ? "- Implementing partner: "+partner+"\n" : ""}

Need statement (CHNA):
${evidence}

CRA criterion satisfied:
${opp ? opp.criterion : "—"}

Geographic attribution:
- Assessment area targeting: document beneficiary location and service footprint.
${scopeNote ? "- Notes: "+scopeNote+"\n" : ""}

Funding structure:
${structure || "TBD (grant / investment / service agreement — choose the structure that best aligns with bank CRA strategy and hospital operations)."}

Budget baseline (annualized):
${state.model ? "- Program cost: "+fmtMoney(state.model.annual_cost)+"\n- Expected net impact: "+fmtMoney(state.model.net_annual)+"\n" : "- Run Tier 3 to populate cost baseline and scenario.\n"}

Evidence & reporting:
${appPacketChecklist(opp ? opp.kind : "nmt")}

Sign‑off workflow:
- Hospital approval: ____________________
- Bank CRA approval: ___________________
`;
    }

    if(draftType==="chna_brief"){
      return `${header}
CHNA Implementation Alignment Brief

CHNA‑documented need:
${evidence}

Selected intervention:
${oppLine}

Implementation summary:
- Target segment(s): older adults prioritized when transportation barriers are amplified; additional eligibility defined by LMI method and service area.
- Delivery model: partner/brokered NEMT with documented ride logs and monitoring.

Budget and evaluation:
${modelBlock}

KPIs:
- Completed rides
- Prevented disruptions (missed appointments)
- Beneficiary counts and geography attribution
- Monthly monitoring with corrective action triggers
`;
    }

    if(draftType==="monitor_plan"){
      return `${header}
Monitoring & Evidence Plan (Exam‑ready)

Selected opportunity:
${oppLine}

Data capture (minimum):
${appPacketChecklist(opp ? opp.kind : "nmt")}

Monitoring cadence:
- Weekly: operational exceptions (cancellations, no‑shows, delayed pickups)
- Monthly: units delivered; beneficiary counts; geography attribution spot check; budget variance
- Quarterly: baseline vs observed disruption rate; program adjustments and corrective actions

Outputs:
- Audit trail pack (contracts/invoices/service logs)
- Quarterly narrative of responsiveness and observed performance
`;
    }


    if(draftType==="pnl"){
      const m = state.model?.outputs;
      if(!m) return `${header}\nP&L Draft unavailable: Run Tier 3 ROI first.\n`;
      const baseNet = m.net_benefit;
      const coding = state.model?.coding?.uplift || 0;
      const totalNet = state.model?.totalNet ?? (baseNet + coding);

      return `${header}
Borrower P&L Statement (Hospital) — Annualized (Draft)

Revenue & Contribution:
- Gross revenue recaptured: ${fmtMoney(m.gross_rev)}
- Less: Marginal clinical cost: ${fmtMoney(m.marginal_cost)}
= Contribution margin from recovered visits: ${fmtMoney(m.gross_rev - m.marginal_cost)}

Program Costs:
- Transportation direct cost: ${fmtMoney(m.transport_cost)}
- Program overhead cost: ${fmtMoney(m.overhead_cost)}
= Total program cost: ${fmtMoney(m.total_program_cost)}

Net Operating Result (Base, Excel parity):
- Net annual benefit: ${fmtMoney(baseNet)}

Optional Coding Layer (if enabled):
- Coding uplift: ${fmtMoney(coding)}
- Net incl. coding uplift: ${fmtMoney(totalNet)}

Notes:
- Base ROI follows Excel-parity incremental margin model.
- Coding uplift is optional and should be supported by documentation workflows and coding governance.
`;
    }

    if(draftType==="proforma_3yr"){
      const m = state.model?.outputs;
      if(!m) return `${header}\n3-Year Pro Forma unavailable: Run Tier 3 ROI first.\n`;

      // simple conservative pro forma: allow growth & inflation assumptions (defaults)
      const growth = parseFloat((document.getElementById("draft_growth")?.value || "5"))/100;
      const infl = parseFloat((document.getElementById("draft_infl")?.value || "3"))/100;

      const y1_rev = m.gross_rev;
      const y1_marg = m.marginal_cost;
      const y1_cost = m.total_program_cost;
      const y1_net = m.net_benefit;

      const rows = [];
      for(let yr=1; yr<=3; yr++){
        const factor = Math.pow(1+growth, yr-1);
        const costFactor = Math.pow(1+infl, yr-1);
        const rev = y1_rev * factor;
        const marg = y1_marg * factor;
        const prog = y1_cost * costFactor;
        const net = rev - marg - prog;
        rows.push({yr, rev, marg, prog, net});
      }

      const table = rows.map(r=>`Year ${r.yr}: Revenue ${fmtMoney(r.rev)} | Marginal cost ${fmtMoney(r.marg)} | Program cost ${fmtMoney(r.prog)} | Net ${fmtMoney(r.net)}`).join("\n");

      return `${header}
Project Pro Forma Budget (3-Year) — Draft

Assumptions:
- Volume/revenue growth on recovered visits: ${(growth*100).toFixed(1)}% / year
- Program cost inflation: ${(infl*100).toFixed(1)}% / year
- Base Year 1 values derived from Tier 3 ROI (Excel parity)

3-Year Summary:
${table}

Interpretation:
- Year 1 is the conservative base case (spreadsheet parity).
- Growth reflects program maturation and improved engagement.
- Inflation reflects vendor and admin cost escalation.
`;
    }

    
    if(draftType==="lender_pnl_3yr" || draftType==="lender_proforma_3yr"){
      // Build a lender-facing, line-item 3-year package.
      // Uses most recent Tier 3 ROI run when available; otherwise derives from current Tier 3 input fields.
      let scen = null;
      try{
        if(state.model && state.model.outputs && state.model.inputs){
          scen = {inp: state.model.inputs, out: state.model.outputs, cu: state.model.coding || {uplift:0, detail:""}, totalNet: (state.model.totalNet ?? (state.model.outputs.net_benefit + ((state.model.coding||{}).uplift||0)))};
        }else{
          const inp = roi_inputs();
          const out = roi_calc(inp);
          const cu = coding_uplift(out.prevented, inp.visits);
          scen = {inp, out, cu, totalNet: (out.net_benefit + cu.uplift)};
        }
      }catch(e){
        scen = null;
      }

      if(!scen){
        return `${header}\nLender-facing financial artifacts unavailable: run Tier 3 ROI (or ensure Tier 3 inputs are present).\n`;
      }

      const growth = parseFloat((document.getElementById("draft_growth")?.value || "5"))/100;
      const infl = parseFloat((document.getElementById("draft_infl")?.value || "3"))/100;

      // Year 1 base (annualized) from ROI parity model
      const y1 = {
        recovered_visits: scen.out.prevented,
        patient_service_revenue: scen.out.gross_rev,
        quality_uplift: scen.cu?.uplift ? scen.cu.uplift : 0,
        total_revenue: scen.out.gross_rev + (scen.cu?.uplift ? scen.cu.uplift : 0),
        marginal_clinical_cost: scen.out.marginal_cost,
        nmt_vendor_cost: scen.out.transport_cost,
        admin_overhead_total: scen.out.overhead_cost,
        total_program_cost: scen.out.total_program_cost,
        net_contribution: (scen.out.gross_rev - scen.out.marginal_cost - scen.out.total_program_cost) + (scen.cu?.uplift ? scen.cu.uplift : 0)
      };

      // Overhead allocation (for line-item transparency; totals reconcile to ROI overhead)
      const ohAlloc = [
        {k:"Program management & operations", p:0.35},
        {k:"Patient outreach, scheduling & confirmations", p:0.20},
        {k:"Data, reporting & audit trail (CRA/CHNA)", p:0.18},
        {k:"Compliance & legal / contracting", p:0.12},
        {k:"Evaluation & continuous improvement", p:0.10},
        {k:"IT/tools (workflow enablement)", p:0.05}
      ];

      function projectYear(base, yr){
        const volF = Math.pow(1+growth, yr-1);
        const costF = Math.pow(1+infl, yr-1);

        const recovered = base.recovered_visits * volF;
        const rev = base.patient_service_revenue * volF;
        const qual = base.quality_uplift * volF; // conservative: tie to volume
        const totRev = rev + qual;

        const marg = base.marginal_clinical_cost * volF;
        const nmt = base.nmt_vendor_cost * costF; // vendor cost inflation
        const oh = base.admin_overhead_total * costF;
        const prog = nmt + oh;

        const net = (rev - marg - prog) + qual;

        return {recovered, rev, qual, totRev, marg, nmt, oh, prog, net};
      }

      const y2 = projectYear(y1, 2);
      const y3 = projectYear(y1, 3);

      const table3 =
`3-Year Summary (annual, $)
| Line item | Year 1 | Year 2 | Year 3 |
|---|---:|---:|---:|
| Recovered visits enabled | ${Math.round(y1.recovered_visits).toLocaleString()} | ${Math.round(y2.recovered).toLocaleString()} | ${Math.round(y3.recovered).toLocaleString()} |
| Patient service revenue (net) | ${fmtMoney(y1.patient_service_revenue)} | ${fmtMoney(y2.rev)} | ${fmtMoney(y3.rev)} |
| Quality / coding uplift (optional) | ${fmtMoney(y1.quality_uplift)} | ${fmtMoney(y2.qual)} | ${fmtMoney(y3.qual)} |
| **Total revenue** | **${fmtMoney(y1.total_revenue)}** | **${fmtMoney(y2.totRev)}** | **${fmtMoney(y3.totRev)}** |
| Marginal clinical cost | ${fmtMoney(y1.marginal_clinical_cost)} | ${fmtMoney(y2.marg)} | ${fmtMoney(y3.marg)} |
| NEMT vendor expense (variable) | ${fmtMoney(y1.nmt_vendor_cost)} | ${fmtMoney(y2.nmt)} | ${fmtMoney(y3.nmt)} |
| Admin/overhead (allocated) | ${fmtMoney(y1.admin_overhead_total)} | ${fmtMoney(y2.oh)} | ${fmtMoney(y3.oh)} |
| **Total program cost** | **${fmtMoney(y1.total_program_cost)}** | **${fmtMoney(y2.prog)}** | **${fmtMoney(y3.prog)}** |
| **Net contribution (EBITDA-like)** | **${fmtMoney(y1.net_contribution)}** | **${fmtMoney(y2.net)}** | **${fmtMoney(y3.net)}** |
`;

      const overheadDetail = ohAlloc.map(a=>{
        const v1 = y1.admin_overhead_total * a.p;
        const v2 = y2.oh * a.p;
        const v3 = y3.oh * a.p;
        return `| ${a.k} | ${fmtMoney(v1)} | ${fmtMoney(v2)} | ${fmtMoney(v3)} |`;
      }).join("\n");

      const overheadTable =
`Overhead detail (reconciles to ROI overhead; for lender transparency)
| Overhead line item | Year 1 | Year 2 | Year 3 |
|---|---:|---:|---:|
${overheadDetail}
| **Total allocated overhead** | **${fmtMoney(y1.admin_overhead_total)}** | **${fmtMoney(y2.oh)}** | **${fmtMoney(y3.oh)}** |
`;

      const assumptions =
`Core assumptions (from Tier 3 inputs)
- Annual targeted visits: ${Math.round(scen.inp.visits).toLocaleString()}
- No-show rate: ${(scen.inp.noshow*100).toFixed(1)}%
- Share due to transportation: ${(scen.inp.share*100).toFixed(1)}%
- Mitigation (prevented share): ${(scen.inp.mitig*100).toFixed(1)}%
- Net revenue per recovered visit: $${(scen.inp.netrev||0).toFixed(0)}
- Marginal clinical cost per recovered visit: $${(scen.inp.margc||0).toFixed(0)}
- Trip cost: $${(scen.inp.trip||0).toFixed(0)}  | Overhead rate: ${(scen.inp.over*100).toFixed(1)}%
- Growth on recovered volume: ${(growth*100).toFixed(1)}%/yr  | Cost inflation: ${(infl*100).toFixed(1)}%/yr
`;

      if(draftType==="lender_pnl_3yr"){
        return `${header}
LENDER-FACING 3-YEAR P&L (Incremental Program Economics — Line-Item)

Purpose
This statement isolates incremental operating impact of a CRA-aligned access program on the hospital (borrower),
using the dashboard ROI scenario as the Year 1 base and projecting Years 2–3 using the selected growth/inflation assumptions.

${assumptions}

${table3}

${overheadTable}

Lender notes (how to underwrite this)
- Revenue line represents net patient service revenue recovered from prevented transportation-related no-shows.
- Marginal clinical cost reflects variable clinical expense tied to recovered visits (not fully loaded fixed cost).
- Program cost is variable with volume and vendor pricing; overhead is transparently allocated for governance, audit, and reporting.
- Optional “quality/coding uplift” should be included only if documentation and coding governance controls are implemented (e.g., workflow prompts, QA sampling).

Risk controls (what reduces variability)
- Eligibility + ride-log documentation to minimize leakage and support CRA/CHNA defensibility.
- Vendor SLA (on-time pickup, completion rate) + monthly variance review.
- Audit-ready evidence pack (contracts, invoices, beneficiary counts, AA attribution).

Generated: ${new Date().toISOString()}
`;
      }

      // lender_proforma_3yr
      const sourcesUses =
`Sources & Uses (illustrative; editable)
Sources:
- Bank CRA contribution (annual): $${(scen.inp.bank||0).toLocaleString()}
- Hospital contribution (annual): ${fmtMoney(Math.max(0, y1.total_program_cost - (scen.inp.bank||0)))}
Uses:
- NEMT vendor expense: ${fmtMoney(y1.nmt_vendor_cost)}
- Program overhead (allocated): ${fmtMoney(y1.admin_overhead_total)}
`;

      return `${header}
LENDER-FACING 3-YEAR PRO FORMA (Budget + Performance — Line-Item)

Purpose
This pro forma is structured as a lender-ready attachment: (1) clear assumptions, (2) line-item cost structure,
(3) projected operating contribution, and (4) documentation / controls that reduce performance risk.

${assumptions}

${sourcesUses}

${table3}

${overheadTable}

Performance monitoring (what the lender can request quarterly)
- Volumes: rides delivered; recovered visits; cancellation/no-show rates.
- Financial: program cost per recovered visit; net contribution; variance to pro forma.
- Compliance: evidence completeness (contracts/invoices/ride logs/beneficiary counts); AA and LMI attribution checks.
- Outcomes: appointment adherence trend; patient experience measures (optional).

Generated: ${new Date().toISOString()}
`;
    }
// fallback
    return `${header}\nNo draft type selected.\n`;
  }

  function wireDraftUI(){
    const genBtn = document.getElementById("btn_generate_draft");
    if(!genBtn) return; // view not present
    genBtn.addEventListener("click", ()=>{
      const type = document.getElementById("draft_type").value;
      const kind = document.getElementById("draft_activity").value;
      const tone = document.getElementById("draft_tone").value;
      const txt = generateDraft(type, kind, tone);
      document.getElementById("draft_preview").textContent = txt;
    });

    document.getElementById("btn_copy_draft").addEventListener("click", async ()=>{
      const txt = document.getElementById("draft_preview").textContent || "";
      try{
        await navigator.clipboard.writeText(txt);
        showOk("Draft copied to clipboard.");
      }catch(e){
        showOk("Copy failed in this browser. You can manually select the text and copy.");
      }
    });

    document.getElementById("btn_download_draft").addEventListener("click", ()=>{
      const txt = document.getElementById("draft_preview").textContent || "";
      const blob = new Blob([txt], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const type = document.getElementById("draft_type").value;
      a.download = `cra_application_${type}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }


  function _num(id){
    const el = document.getElementById(id);
    if(!el) return 0;
    let v = parseFloat(el.value);
    if(isNaN(v)) return 0;
    return (v > 1) ? v/100 : v; // normalize percent-style
  }

  function render_roi(){
    try{
      const visits = parseFloat(document.getElementById("a_visits").value);
      const noshow = _num("a_noshow");
      const share = _num("a_share");
      const netrev = parseFloat(document.getElementById("a_netrev").value);
      const margc = parseFloat(document.getElementById("a_margc").value);
      const mitig = _num("b_mitig");
      const trip = parseFloat(document.getElementById("b_trip").value);
      const over = _num("b_over");

      const transport_no_shows = visits * noshow * share;
      const prevented = transport_no_shows * mitig;
      const gross_rev = prevented * netrev;
      const marginal_cost = prevented * margc;
      const transport_cost = prevented * trip;
      const overhead_cost = transport_cost * over;
      const total_cost = transport_cost + overhead_cost;
      const net = gross_rev - marginal_cost - total_cost;
      const roi = total_cost === 0 ? 0 : net/total_cost;
      const be_trip = netrev - margc;

      document.getElementById("o_net").textContent = "$" + net.toLocaleString();
      document.getElementById("o_cost").textContent = "$" + total_cost.toLocaleString();
      document.getElementById("o_roi").textContent = roi.toFixed(2) + "x";
      document.getElementById("o_tripmax").textContent = "$" + be_trip.toFixed(0);

      const ctx = document.getElementById("roi_bar");
      if(ctx){
        new Chart(ctx, {
          type:"bar",
          data:{
            labels:["Gross Revenue","Marginal Cost","Program Cost","Net Benefit"],
            datasets:[{data:[gross_rev,marginal_cost,total_cost,net]}]
          },
          options:{plugins:{legend:{display:false}}}
        });
      }

    }catch(e){
      console.error(e);
      alert("ROI error: " + e.message);
    }
  }


  function _normRate(x){
    // Accept decimals (0.2) or percents (20)
    if(isNaN(x)) return 0;
    return (x > 1) ? (x/100) : x;
  }

  function roi_inputs(){
    const visits = parseFloat(document.getElementById("a_visits").value) || 0;
    return {
      visits,
      noshow: _normRate(parseFloat(document.getElementById("a_noshow").value)),
      share: _normRate(parseFloat(document.getElementById("a_share").value)),
      netrev: parseFloat(document.getElementById("a_netrev").value) || 0,
      margc: parseFloat(document.getElementById("a_margc").value) || 0,
      mitig: _normRate(parseFloat(document.getElementById("b_mitig").value)),
      trip: parseFloat(document.getElementById("b_trip").value) || 0,
      over: _normRate(parseFloat(document.getElementById("b_over").value)),
      lmi: _normRate(parseFloat(document.getElementById("c_lmi").value)),
      aa: _normRate(parseFloat(document.getElementById("c_aa").value)),
      bank: parseFloat(document.getElementById("c_bank").value) || 0
    };
  }

  function roi_calc(inp){
    const transport_no_shows = inp.visits * inp.noshow * inp.share;
    const prevented = transport_no_shows * inp.mitig;
    const gross_rev = prevented * inp.netrev;
    const marginal_cost = prevented * inp.margc;
    const transport_cost = prevented * inp.trip;
    const overhead_cost = transport_cost * inp.over;
    const total_program_cost = transport_cost + overhead_cost;
    const net_benefit = gross_rev - marginal_cost - total_program_cost;
    const be_trip_max = inp.netrev - inp.margc;

    const trips = prevented;
    const lmi_trips = trips * inp.lmi;
    const aa_trips = trips * inp.aa;
    const bank_per_lmi = (lmi_trips===0) ? 0 : (inp.bank/lmi_trips);
    const bank_share_cost = (total_program_cost===0) ? 0 : (inp.bank/total_program_cost);

    const narrative = `Estimated ${Math.round(lmi_trips).toLocaleString()} LMI trips and ${Math.round(trips).toLocaleString()} essential visits enabled annually within the Assessment Area.`;
    return {transport_no_shows, prevented, gross_rev, marginal_cost, transport_cost, overhead_cost, total_program_cost, net_benefit, be_trip_max,
            trips, lmi_trips, aa_trips, bank_per_lmi, bank_share_cost, narrative};
  }

  function coding_uplift(preventedVisits, allVisits){
    const enabled = document.getElementById("toggle_coding").checked;
    if(!enabled) return {uplift:0, detail:"Coding layer not enabled."};

    const zRate = _normRate(parseFloat(document.getElementById("z_rate").value));
    const zUplift = parseFloat(document.getElementById("z_uplift").value) || 0;
    const cptRate = _normRate(parseFloat(document.getElementById("cpt_rate").value));
    const cptUplift = parseFloat(document.getElementById("cpt_uplift").value) || 0;
    const base = document.getElementById("coding_base").value; // prevented | all
    const n = (base === "all") ? allVisits : preventedVisits;

    const zAdd = n * zRate * zUplift;
    const cptAdd = n * cptRate * cptUplift;
    const uplift = zAdd + cptAdd;

    const notes = (document.getElementById("coding_notes").value || "").trim();
    const detail = `Coding uplift applied to ${base === "all" ? "all targeted visits" : "recovered visits"}:
- Z-code capture: ${(zRate*100).toFixed(1)}% × $${zUplift.toFixed(0)} = $${zAdd.toFixed(0)}
- CPT capture: ${(cptRate*100).toFixed(1)}% × $${cptUplift.toFixed(0)} = $${cptAdd.toFixed(0)}
${notes ? "- Notes: " + notes : ""}`.trim();

    return {uplift, detail};
  }

  function render_roi(){
    const inp = roi_inputs();
    const out = roi_calc(inp);

    // Base KPI outputs (Excel parity)
    document.getElementById("o_net").textContent = "$" + out.net_benefit.toLocaleString(undefined,{maximumFractionDigits:0});
    document.getElementById("o_tripmax").textContent = "$" + out.be_trip_max.toFixed(0);
    document.getElementById("o_cost").textContent = "$" + out.total_program_cost.toLocaleString(undefined,{maximumFractionDigits:0});

    // Coding uplift (optional)
    const cu = coding_uplift(out.prevented, inp.visits);
    document.getElementById("o_code").textContent = "$" + cu.uplift.toLocaleString(undefined,{maximumFractionDigits:0});

    const totalNet = out.net_benefit + cu.uplift;
    document.getElementById("o_total_net").textContent = "$" + totalNet.toLocaleString(undefined,{maximumFractionDigits:0});

    const roiTotal = (out.total_program_cost===0) ? 0 : (totalNet / out.total_program_cost);
    document.getElementById("o_roi").textContent = (out.total_program_cost===0) ? "—" : roiTotal.toFixed(2) + "x";

    // Chart
    const ctx = document.getElementById("roi_bar");
    if(ctx){
      new Chart(ctx, {
        type:"bar",
        data:{
          labels:["Gross revenue recaptured","Marginal clinical cost","Total program cost","Base net benefit","Coding uplift","Net incl. coding"],
          datasets:[{data:[out.gross_rev,out.marginal_cost,out.total_program_cost,out.net_benefit,cu.uplift,totalNet]}]
        },
        options:{plugins:{legend:{display:false}}}
      });
    }

    // CRA outputs (unchanged)
    const craTxt =
`Trips delivered (round trips): ${Math.round(out.trips).toLocaleString()}
LMI trips: ${Math.round(out.lmi_trips).toLocaleString()}
AA trips: ${Math.round(out.aa_trips).toLocaleString()}

Bank annual contribution: $${inp.bank.toLocaleString()}
Bank contribution per LMI trip: $${out.bank_per_lmi.toFixed(0)}
Share of total program cost funded by Bank: ${(out.bank_share_cost*100).toFixed(1)}%

Narrative-ready summary:
${out.narrative}`;
    document.getElementById("cra_box").textContent = craTxt;

    // Audit memo
    document.getElementById("roi_audit").textContent =
`Tier 3 — Excel-parity ROI + Coding ROI Layer

Base ROI (Excel parity):
- Net benefit: $${out.net_benefit.toFixed(0)}
- Total program cost: $${out.total_program_cost.toFixed(0)}
- Break-even trip cost max: $${out.be_trip_max.toFixed(0)}

Coding ROI Layer:
${cu.detail}

Total net (incl. coding): $${totalNet.toFixed(0)}
ROI incl. coding: ${out.total_program_cost===0 ? "—" : roiTotal.toFixed(2)+"x"}

Generated: ${new Date().toISOString()}`;

    // persist for draft generator
    state.model = { roi_parity:true, inputs: inp, outputs: out, coding: cu, totalNet, roiTotal };
  }


  (function(){
    const t = document.getElementById("toggle_coding");
    const box = document.getElementById("coding_box");
    if(t && box){
      t.addEventListener("change", ()=>{ box.style.display = t.checked ? "block" : "none"; });
    }
  })();


  // ------------------------------
  // Tier 3 Coding layer UX: recompute on toggle/input changes
  // ------------------------------
  (function(){
    const t = document.getElementById("toggle_coding");
    const box = document.getElementById("coding_box");
    if(t && box){
      const sync = ()=>{ box.style.display = t.checked ? "block" : "none"; };
      sync();
      t.addEventListener("change", ()=>{ sync(); if(typeof render_roi === "function") render_roi(); });
      ["z_rate","z_uplift","cpt_rate","cpt_uplift","coding_base"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener("change", ()=>{ if(typeof render_roi === "function") render_roi(); });
        if(el) el.addEventListener("input", ()=>{ if(typeof render_roi === "function") render_roi(); });
      });
    }
  })();

  // ------------------------------
  // Tier 4-6 generators (prototype content)
  // ------------------------------
  window.copy_block = async function(id){
    const el = document.getElementById(id);
    if(!el) return;
    const txt = el.textContent || "";
    try{ await navigator.clipboard.writeText(txt); showOk("Copied."); }catch(e){ showOk("Copy not available; select text manually."); }
  };

  window.generate_impl_plan = function(){
    const opp = state.opportunities?.[0];
    const m = state.model?.outputs;
    const txt =
`Implementation Plan (30-60-90)

Selected opportunity: ${opp ? opp.opp : "—"}
CRA criterion satisfied: ${opp ? opp.criterion : "—"}

0–30 days
- Confirm target geography and eligible population (LMI method) and document AA attribution.
- Finalize partner/vendor and service workflow (scheduling, eligibility, ride confirmation, documentation).
- Build the evidence packet template (contracts, invoices, ride logs, beneficiary counts).

31–60 days
- Launch pilot; begin weekly operational monitoring.
- Collect ride logs, completed visits enabled, cancellations/no-shows, and beneficiary ZIP/tract.
- Produce first monthly report: volumes, costs, and exceptions.

61–90 days
- Compare baseline vs observed: transport-related no-shows prevented.
- Adjust workflow; document corrective actions.
- Produce quarterly outcomes report for CRA file and hospital leadership.

${m ? "\nCurrent ROI baseline:\n- Prevented no-shows: "+Math.round(m.prevented).toLocaleString()+"\n- Net benefit: "+fmtMoney(m.net_benefit) : ""}`;
    document.getElementById("impl_plan").textContent = txt;
  };

  window.generate_outcomes_report = function(){
    const opp = state.opportunities?.[0];
    const m = state.model?.outputs;
    const txt =
`Quarterly Outcomes Report Template

Project: ${opp ? opp.opp : "—"}
Reporting period: ___________________

Operational Outputs
- Trips delivered (round trips): ${m ? Math.round(m.trips).toLocaleString() : "—"}
- Completed visits enabled: ${m ? Math.round(m.prevented).toLocaleString() : "—"}
- Cancellation rate: _______
- On-time pickup rate: _______

Beneficiary & Scope (CRA)
- % LMI: _______   (method: _______)
- LMI trips: ${m ? Math.round(m.lmi_trips).toLocaleString() : "—"}
- % within AA: _______
- AA trips: ${m ? Math.round(m.aa_trips).toLocaleString() : "—"}

Financial (Hospital)
- Gross revenue recaptured: ${m ? fmtMoney(m.gross_rev) : "—"}
- Total program cost: ${m ? fmtMoney(m.total_program_cost) : "—"}
- Net annual benefit (base): ${m ? fmtMoney(m.net_benefit) : "—"}

Narrative
- Describe responsiveness to documented CHNA need and any adjustments made.
`;
    document.getElementById("outcomes_report").textContent = txt;
  };

  window.generate_eval_plan = function(){
    const opp = state.opportunities?.[0];
    const txt =
`Evaluation Plan Template

1) Purpose
Evaluate whether the intervention reduces transport-related missed appointments and improves access for the target population.

2) Baseline
- Baseline no-show rate (overall): _______
- Transport-attributable no-show share: _______
- CHNA evidence citations: ${state.findings?.slice(0,3).map(f=>f.evidenceRef).filter(Boolean).join("; ") || "—"}

3) Design
- Pre/post comparison (baseline period vs intervention period)
- Stratify by: age group (65–74), LMI status, and geography (AA)

4) Metrics
- Primary: prevented no-shows, trips delivered, completed visits enabled
- Secondary: downstream utilization proxies (optional), patient experience, timeliness
- CRA: LMI trips, AA trips, bank $/LMI trip

5) Data sources
- Scheduling system, ride logs, billing/RVUs, SDOH screening/Z-codes (if enabled)

6) Governance & cadence
- Weekly ops huddle, monthly reporting, quarterly executive review
- Corrective action triggers: missed pickup rate, high cancellations, documentation gaps

7) Deliverables
- Quarterly outcomes report
- Year-end evaluation report with lessons learned and scaling recommendation
`;
    document.getElementById("eval_plan").textContent = txt;
  };

</script>
</body>
</html>
